<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Gem::Security::Policy</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            Gem::Security::Policy 
            
                <span class="parent">&lt; 
                    
                    <a href="../../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/rubygems/security_rb.html">lib/rubygems/security.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
<a href="../../A.html">A</a> <a
href="Policy.html">Gem::Security::Policy</a> object encapsulates the
settings for verifying signed gem files. This is the base class. You can
either declare an instance of this or use one of the preset security
policies below.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M005883">new</a></li>
                
            </ul>
        </dd>
    
        <dt>T</dt>
        <dd>
            <ul>
                
                <li><a href="#M005884">trusted_cert_path</a></li>
                
            </ul>
        </dd>
    
        <dt>V</dt>
        <dd>
            <ul>
                
                <li><a href="#M005885">verify_gem</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>verify_data</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>verify_signer</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>verify_chain</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>verify_root</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>only_trusted</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>only_signed</td>
            <td class='attr-desc'></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M005883">
                    
                    <a name="M005883"></a><b>new</b>(policy = {}, opt = {})
                    
                </div>
                
                <div class="description">
                  <p>
Create a new <a href="Policy.html">Gem::Security::Policy</a> object with
the given mode and options.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005883_source')" id="l_M005883_source">show</a>
                        
                    </p>
                    <div id="M005883_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/security.rb, line 381</span>
381:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">policy</span> = {}, <span class="ruby-identifier">opt</span> = {})
382:       <span class="ruby-comment cmt"># set options</span>
383:       <span class="ruby-ivar">@opt</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">OPT</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">opt</span>)
384: 
385:       <span class="ruby-comment cmt"># build policy</span>
386:       <span class="ruby-identifier">policy</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">val</span><span class="ruby-operator">|</span>
387:         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">key</span>
388:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:verify_data</span>   <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@verify_data</span>   = <span class="ruby-identifier">val</span>
389:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:verify_signer</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@verify_signer</span> = <span class="ruby-identifier">val</span>
390:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:verify_chain</span>  <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@verify_chain</span>  = <span class="ruby-identifier">val</span>
391:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:verify_root</span>   <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@verify_root</span>   = <span class="ruby-identifier">val</span>
392:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:only_trusted</span>  <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@only_trusted</span>  = <span class="ruby-identifier">val</span>
393:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:only_signed</span>   <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@only_signed</span>   = <span class="ruby-identifier">val</span>
394:         <span class="ruby-keyword kw">end</span>
395:       <span class="ruby-keyword kw">end</span>
396:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005884">
                    
                    <a name="M005884"></a><b>trusted_cert_path</b>(cert, opt = {})
                    
                </div>
                
                <div class="description">
                  <p>
Get the path to the file for this cert.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005884_source')" id="l_M005884_source">show</a>
                        
                    </p>
                    <div id="M005884_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/security.rb, line 401</span>
401:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">trusted_cert_path</span>(<span class="ruby-identifier">cert</span>, <span class="ruby-identifier">opt</span> = {})
402:       <span class="ruby-identifier">opt</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">OPT</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">opt</span>)
403: 
404:       <span class="ruby-comment cmt"># get digest algorithm, calculate checksum of root.subject</span>
405:       <span class="ruby-identifier">algo</span> = <span class="ruby-identifier">opt</span>[<span class="ruby-identifier">:dgst_algo</span>]
406:       <span class="ruby-identifier">dgst</span> = <span class="ruby-identifier">algo</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-identifier">cert</span>.<span class="ruby-identifier">subject</span>.<span class="ruby-identifier">to_s</span>)
407: 
408:       <span class="ruby-comment cmt"># build path to trusted cert file</span>
409:       <span class="ruby-identifier">name</span> = <span class="ruby-node">&quot;cert-#{dgst}.pem&quot;</span>
410: 
411:       <span class="ruby-comment cmt"># join and return path components</span>
412:       <span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-identifier">join</span>(<span class="ruby-identifier">opt</span>[<span class="ruby-identifier">:trust_dir</span>], <span class="ruby-identifier">name</span>)
413:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M005885">
                    
                    <a name="M005885"></a><b>verify_gem</b>(signature, data, chain, time = Time.now)
                    
                </div>
                
                <div class="description">
                  <p>
Verify that the gem data with the given signature and signing chain matched
this security policy at the specified time.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005885_source')" id="l_M005885_source">show</a>
                        
                    </p>
                    <div id="M005885_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/security.rb, line 419</span>
419:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">verify_gem</span>(<span class="ruby-identifier">signature</span>, <span class="ruby-identifier">data</span>, <span class="ruby-identifier">chain</span>, <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
420:       <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">ensure_ssl_available</span>
421:       <span class="ruby-identifier">cert_class</span> = <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">X509</span><span class="ruby-operator">::</span><span class="ruby-constant">Certificate</span>
422:       <span class="ruby-identifier">exc</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
423:       <span class="ruby-identifier">chain</span> <span class="ruby-operator">||=</span> []
424: 
425:       <span class="ruby-identifier">chain</span> = <span class="ruby-identifier">chain</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">str</span><span class="ruby-operator">|</span> <span class="ruby-identifier">cert_class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">str</span>) }
426:       <span class="ruby-identifier">signer</span>, <span class="ruby-identifier">ch_len</span> = <span class="ruby-identifier">chain</span>[<span class="ruby-value">-1</span>], <span class="ruby-identifier">chain</span>.<span class="ruby-identifier">size</span>
427: 
428:       <span class="ruby-comment cmt"># make sure signature is valid</span>
429:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@verify_data</span>
430:         <span class="ruby-comment cmt"># get digest algorithm (TODO: this should be configurable)</span>
431:         <span class="ruby-identifier">dgst</span> = <span class="ruby-ivar">@opt</span>[<span class="ruby-identifier">:dgst_algo</span>]
432: 
433:         <span class="ruby-comment cmt"># verify the data signature (this is the most important part, so don't</span>
434:         <span class="ruby-comment cmt"># screw it up :D)</span>
435:         <span class="ruby-identifier">v</span> = <span class="ruby-identifier">signer</span>.<span class="ruby-identifier">public_key</span>.<span class="ruby-identifier">verify</span>(<span class="ruby-identifier">dgst</span>.<span class="ruby-identifier">new</span>, <span class="ruby-identifier">signature</span>, <span class="ruby-identifier">data</span>)
436:         <span class="ruby-identifier">raise</span> <span class="ruby-identifier">exc</span>, <span class="ruby-value str">&quot;Invalid Gem Signature&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">v</span>
437: 
438:         <span class="ruby-comment cmt"># make sure the signer is valid</span>
439:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@verify_signer</span>
440:           <span class="ruby-comment cmt"># make sure the signing cert is valid right now</span>
441:           <span class="ruby-identifier">v</span> = <span class="ruby-identifier">signer</span>.<span class="ruby-identifier">check_validity</span>(<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">time</span>)
442:           <span class="ruby-identifier">raise</span> <span class="ruby-identifier">exc</span>, <span class="ruby-node">&quot;Invalid Signature: #{v[:desc]}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">v</span>[<span class="ruby-identifier">:is_valid</span>]
443:         <span class="ruby-keyword kw">end</span>
444:       <span class="ruby-keyword kw">end</span>
445: 
446:       <span class="ruby-comment cmt"># make sure the certificate chain is valid</span>
447:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@verify_chain</span>
448:         <span class="ruby-comment cmt"># iterate down over the chain and verify each certificate against it's</span>
449:         <span class="ruby-comment cmt"># issuer</span>
450:         (<span class="ruby-identifier">ch_len</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">downto</span>(<span class="ruby-value">1</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
451:           <span class="ruby-identifier">issuer</span>, <span class="ruby-identifier">cert</span> = <span class="ruby-identifier">chain</span>[<span class="ruby-identifier">i</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-value">2</span>]
452:           <span class="ruby-identifier">v</span> = <span class="ruby-identifier">cert</span>.<span class="ruby-identifier">check_validity</span>(<span class="ruby-identifier">issuer</span>, <span class="ruby-identifier">time</span>)
453:           <span class="ruby-identifier">raise</span> <span class="ruby-identifier">exc</span>, <span class="ruby-value str">&quot;%s: cert = '%s', error = '%s'&quot;</span> <span class="ruby-operator">%</span> [
454:               <span class="ruby-value str">'Invalid Signing Chain'</span>, <span class="ruby-identifier">cert</span>.<span class="ruby-identifier">subject</span>, <span class="ruby-identifier">v</span>[<span class="ruby-identifier">:desc</span>]
455:           ] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">v</span>[<span class="ruby-identifier">:is_valid</span>]
456:         <span class="ruby-keyword kw">end</span>
457: 
458:         <span class="ruby-comment cmt"># verify root of chain</span>
459:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@verify_root</span>
460:           <span class="ruby-comment cmt"># make sure root is self-signed</span>
461:           <span class="ruby-identifier">root</span> = <span class="ruby-identifier">chain</span>[<span class="ruby-value">0</span>]
462:           <span class="ruby-identifier">raise</span> <span class="ruby-identifier">exc</span>, <span class="ruby-value str">&quot;%s: %s (subject = '%s', issuer = '%s')&quot;</span> <span class="ruby-operator">%</span> [
463:               <span class="ruby-value str">'Invalid Signing Chain Root'</span>,
464:               <span class="ruby-value str">'Subject does not match Issuer for Gem Signing Chain'</span>,
465:               <span class="ruby-identifier">root</span>.<span class="ruby-identifier">subject</span>.<span class="ruby-identifier">to_s</span>,
466:               <span class="ruby-identifier">root</span>.<span class="ruby-identifier">issuer</span>.<span class="ruby-identifier">to_s</span>,
467:           ] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">root</span>.<span class="ruby-identifier">issuer</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">root</span>.<span class="ruby-identifier">subject</span>.<span class="ruby-identifier">to_s</span>
468: 
469:           <span class="ruby-comment cmt"># make sure root is valid</span>
470:           <span class="ruby-identifier">v</span> = <span class="ruby-identifier">root</span>.<span class="ruby-identifier">check_validity</span>(<span class="ruby-identifier">root</span>, <span class="ruby-identifier">time</span>)
471:           <span class="ruby-identifier">raise</span> <span class="ruby-identifier">exc</span>, <span class="ruby-value str">&quot;%s: cert = '%s', error = '%s'&quot;</span> <span class="ruby-operator">%</span> [
472:               <span class="ruby-value str">'Invalid Signing Chain Root'</span>, <span class="ruby-identifier">root</span>.<span class="ruby-identifier">subject</span>, <span class="ruby-identifier">v</span>[<span class="ruby-identifier">:desc</span>]
473:           ] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">v</span>[<span class="ruby-identifier">:is_valid</span>]
474: 
475:           <span class="ruby-comment cmt"># verify that the chain root is trusted</span>
476:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@only_trusted</span>
477:             <span class="ruby-comment cmt"># get digest algorithm, calculate checksum of root.subject</span>
478:             <span class="ruby-identifier">algo</span> = <span class="ruby-ivar">@opt</span>[<span class="ruby-identifier">:dgst_algo</span>]
479:             <span class="ruby-identifier">path</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Policy</span>.<span class="ruby-identifier">trusted_cert_path</span>(<span class="ruby-identifier">root</span>, <span class="ruby-ivar">@opt</span>)
480: 
481:             <span class="ruby-comment cmt"># check to make sure trusted path exists</span>
482:             <span class="ruby-identifier">raise</span> <span class="ruby-identifier">exc</span>, <span class="ruby-value str">&quot;%s: cert = '%s', error = '%s'&quot;</span> <span class="ruby-operator">%</span> [
483:                 <span class="ruby-value str">'Untrusted Signing Chain Root'</span>,
484:                 <span class="ruby-identifier">root</span>.<span class="ruby-identifier">subject</span>.<span class="ruby-identifier">to_s</span>,
485:                 <span class="ruby-node">&quot;path \&quot;#{path}\&quot; does not exist&quot;</span>,
486:             ] <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">path</span>)
487: 
488:             <span class="ruby-comment cmt"># load calculate digest from saved cert file</span>
489:             <span class="ruby-identifier">save_cert</span> = <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">X509</span><span class="ruby-operator">::</span><span class="ruby-constant">Certificate</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">path</span>))
490:             <span class="ruby-identifier">save_dgst</span> = <span class="ruby-identifier">algo</span>.<span class="ruby-identifier">digest</span>(<span class="ruby-identifier">save_cert</span>.<span class="ruby-identifier">public_key</span>.<span class="ruby-identifier">to_s</span>)
491: 
492:             <span class="ruby-comment cmt"># create digest of public key</span>
493:             <span class="ruby-identifier">pkey_str</span> = <span class="ruby-identifier">root</span>.<span class="ruby-identifier">public_key</span>.<span class="ruby-identifier">to_s</span>
494:             <span class="ruby-identifier">cert_dgst</span> = <span class="ruby-identifier">algo</span>.<span class="ruby-identifier">digest</span>(<span class="ruby-identifier">pkey_str</span>)
495: 
496:             <span class="ruby-comment cmt"># now compare the two digests, raise exception</span>
497:             <span class="ruby-comment cmt"># if they don't match</span>
498:             <span class="ruby-identifier">raise</span> <span class="ruby-identifier">exc</span>, <span class="ruby-value str">&quot;%s: %s (saved = '%s', root = '%s')&quot;</span> <span class="ruby-operator">%</span> [
499:                 <span class="ruby-value str">'Invalid Signing Chain Root'</span>,
500:                 <span class="ruby-value str">&quot;Saved checksum doesn't match root checksum&quot;</span>,
501:                 <span class="ruby-identifier">save_dgst</span>, <span class="ruby-identifier">cert_dgst</span>,
502:             ] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">save_dgst</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">cert_dgst</span>
503:           <span class="ruby-keyword kw">end</span>
504:         <span class="ruby-keyword kw">end</span>
505: 
506:         <span class="ruby-comment cmt"># return the signing chain</span>
507:         <span class="ruby-identifier">chain</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">cert</span><span class="ruby-operator">|</span> <span class="ruby-identifier">cert</span>.<span class="ruby-identifier">subject</span> }
508:       <span class="ruby-keyword kw">end</span>
509:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    