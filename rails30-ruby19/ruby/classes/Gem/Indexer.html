<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Gem::Indexer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            Gem::Indexer 
            
                <span class="parent">&lt; 
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/rubygems/indexer_rb.html">lib/rubygems/indexer.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Top level class for building the gem repository index.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>A</dt>
        <dd>
            <ul>
                
                <li><a href="#M005446">abbreviate</a></li>
                
            </ul>
        </dd>
    
        <dt>B</dt>
        <dd>
            <ul>
                
                <li><a href="#M005447">build_indicies</a>,</li>
                
                <li><a href="#M005448">build_legacy_indicies</a>,</li>
                
                <li><a href="#M005449">build_marshal_gemspecs</a>,</li>
                
                <li><a href="#M005450">build_modern_index</a>,</li>
                
                <li><a href="#M005451">build_modern_indicies</a>,</li>
                
                <li><a href="#M005452">build_rss</a></li>
                
            </ul>
        </dd>
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M005453">collect_specs</a>,</li>
                
                <li><a href="#M005455">compact_specs</a>,</li>
                
                <li><a href="#M005456">compress</a>,</li>
                
                <li><a href="#M005454">compress_indicies</a></li>
                
            </ul>
        </dd>
    
        <dt>G</dt>
        <dd>
            <ul>
                
                <li><a href="#M005457">gem_file_list</a>,</li>
                
                <li><a href="#M005458">generate_index</a>,</li>
                
                <li><a href="#M005459">gzip</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M005460">install_indicies</a></li>
                
            </ul>
        </dd>
    
        <dt>M</dt>
        <dd>
            <ul>
                
                <li><a href="#M005476">make_temp_directories</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M005445">new</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M005477">paranoid</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M005478">sanitize</a>,</li>
                
                <li><a href="#M005479">sanitize_string</a></li>
                
            </ul>
        </dd>
    
        <dt>U</dt>
        <dd>
            <ul>
                
                <li><a href="#M005480">update_index</a>,</li>
                
                <li><a href="#M005481">update_specs_index</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="../Kernel.html">Kernel</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>build_legacy</td>
            <td class='attr-desc'><p>
Build indexes for RubyGems older than 1.2.0 when true
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>build_modern</td>
            <td class='attr-desc'><p>
Build indexes for RubyGems 1.2.0 and newer when true
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>dest_directory</td>
            <td class='attr-desc'><p>
Index install location
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>dest_specs_index</td>
            <td class='attr-desc'><p>
Specs index install location
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>dest_latest_specs_index</td>
            <td class='attr-desc'><p>
Latest specs index install location
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>dest_prerelease_specs_index</td>
            <td class='attr-desc'><p>
Prerelease specs index install location
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>directory</td>
            <td class='attr-desc'><p>
Index build directory
</p></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M005445">
                    
                    <a name="M005445"></a><b>new</b>(directory, options = {})
                    
                </div>
                
                <div class="description">
                  <p>
Create an indexer that will index the gems in <tt>directory</tt>.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005445_source')" id="l_M005445_source">show</a>
                        
                    </p>
                    <div id="M005445_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 59</span>
 59:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">directory</span>, <span class="ruby-identifier">options</span> = {})
 60:     <span class="ruby-keyword kw">unless</span> <span class="ruby-value str">''</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-identifier">:to_xs</span> <span class="ruby-keyword kw">then</span>
 61:       <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Gem::Indexer requires that the XML Builder library be installed:&quot;</span> \
 62:            <span class="ruby-value str">&quot;\n\tgem install builder&quot;</span>
 63:     <span class="ruby-keyword kw">end</span>
 64: 
 65:     <span class="ruby-identifier">options</span> = { <span class="ruby-identifier">:build_legacy</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">:build_modern</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> }.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">options</span>
 66: 
 67:     <span class="ruby-ivar">@build_legacy</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:build_legacy</span>]
 68:     <span class="ruby-ivar">@build_modern</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:build_modern</span>]
 69: 
 70:     <span class="ruby-ivar">@rss_title</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:rss_title</span>]
 71:     <span class="ruby-ivar">@rss_host</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:rss_host</span>]
 72:     <span class="ruby-ivar">@rss_gems_host</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:rss_gems_host</span>]
 73: 
 74:     <span class="ruby-ivar">@dest_directory</span> = <span class="ruby-identifier">directory</span>
 75:     <span class="ruby-ivar">@directory</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">tmpdir</span>, <span class="ruby-node">&quot;gem_generate_index_#{$$}&quot;</span>
 76: 
 77:     <span class="ruby-identifier">marshal_name</span> = <span class="ruby-node">&quot;Marshal.#{Gem.marshal_version}&quot;</span>
 78: 
 79:     <span class="ruby-ivar">@master_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-value str">'yaml'</span>
 80:     <span class="ruby-ivar">@marshal_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">marshal_name</span>
 81: 
 82:     <span class="ruby-ivar">@quick_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-value str">'quick'</span>
 83: 
 84:     <span class="ruby-ivar">@quick_marshal_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_dir</span>, <span class="ruby-identifier">marshal_name</span>
 85: 
 86:     <span class="ruby-ivar">@quick_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_dir</span>, <span class="ruby-value str">'index'</span>
 87:     <span class="ruby-ivar">@latest_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_dir</span>, <span class="ruby-value str">'latest_index'</span>
 88: 
 89:     <span class="ruby-ivar">@specs_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-node">&quot;specs.#{Gem.marshal_version}&quot;</span>
 90:     <span class="ruby-ivar">@latest_specs_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>,
 91:                                     <span class="ruby-node">&quot;latest_specs.#{Gem.marshal_version}&quot;</span>
 92:     <span class="ruby-ivar">@prerelease_specs_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@directory</span>,
 93:                                         <span class="ruby-node">&quot;prerelease_specs.#{Gem.marshal_version}&quot;</span>)
 94: 
 95:     <span class="ruby-ivar">@dest_specs_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@dest_directory</span>,
 96:                                   <span class="ruby-node">&quot;specs.#{Gem.marshal_version}&quot;</span>
 97:     <span class="ruby-ivar">@dest_latest_specs_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@dest_directory</span>,
 98:                                          <span class="ruby-node">&quot;latest_specs.#{Gem.marshal_version}&quot;</span>
 99:     <span class="ruby-ivar">@dest_prerelease_specs_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@dest_directory</span>,
100:                                             <span class="ruby-node">&quot;prerelease_specs.#{Gem.marshal_version}&quot;</span>
101: 
102:     <span class="ruby-ivar">@rss_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-value str">'index.rss'</span>
103: 
104:     <span class="ruby-ivar">@files</span> = []
105:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M005446">
                    
                    <a name="M005446"></a><b>abbreviate</b>(spec)
                    
                </div>
                
                <div class="description">
                  <p>
Abbreviate the spec for downloading. Abbreviated specs are only used for
searching, downloading and related activities and do not need deployment
specific information (e.g. list of files). So we abbreviate the spec,
making it much smaller for quicker downloads.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005446_source')" id="l_M005446_source">show</a>
                        
                    </p>
                    <div id="M005446_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 113</span>
113:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">abbreviate</span>(<span class="ruby-identifier">spec</span>)
114:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">files</span> = []
115:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">test_files</span> = []
116:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">rdoc_options</span> = []
117:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">extra_rdoc_files</span> = []
118:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">cert_chain</span> = []
119:     <span class="ruby-identifier">spec</span>
120:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005447">
                    
                    <a name="M005447"></a><b>build_indicies</b>(index)
                    
                </div>
                
                <div class="description">
                  <p>
Build various indicies
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005447_source')" id="l_M005447_source">show</a>
                        
                    </p>
                    <div id="M005447_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 125</span>
125:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_indicies</span>(<span class="ruby-identifier">index</span>)
126:     <span class="ruby-comment cmt"># Marshal gemspecs are used by both modern and legacy RubyGems</span>
127:     <span class="ruby-identifier">build_marshal_gemspecs</span> <span class="ruby-identifier">index</span>
128:     <span class="ruby-identifier">build_legacy_indicies</span> <span class="ruby-identifier">index</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@build_legacy</span>
129:     <span class="ruby-identifier">build_modern_indicies</span> <span class="ruby-identifier">index</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@build_modern</span>
130:     <span class="ruby-identifier">build_rss</span> <span class="ruby-identifier">index</span>
131: 
132:     <span class="ruby-identifier">compress_indicies</span>
133:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005448">
                    
                    <a name="M005448"></a><b>build_legacy_indicies</b>(index)
                    
                </div>
                
                <div class="description">
                  <p>
Builds indicies for RubyGems older than 1.2.x
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005448_source')" id="l_M005448_source">show</a>
                        
                    </p>
                    <div id="M005448_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 138</span>
138:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_legacy_indicies</span>(<span class="ruby-identifier">index</span>)
139:     <span class="ruby-identifier">progress</span> = <span class="ruby-identifier">ui</span>.<span class="ruby-identifier">progress_reporter</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">size</span>,
140:                                     <span class="ruby-node">&quot;Generating YAML quick index gemspecs for #{index.size} gems&quot;</span>,
141:                                     <span class="ruby-value str">&quot;Complete&quot;</span>
142: 
143:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Generated YAML quick index gemspecs'</span> <span class="ruby-keyword kw">do</span>
144:       <span class="ruby-identifier">index</span>.<span class="ruby-identifier">released_gems</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original_name</span>, <span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
145:         <span class="ruby-identifier">spec_file_name</span> = <span class="ruby-node">&quot;#{original_name}.gemspec.rz&quot;</span>
146:         <span class="ruby-identifier">yaml_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_dir</span>, <span class="ruby-identifier">spec_file_name</span>
147: 
148:         <span class="ruby-identifier">yaml_zipped</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">deflate</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">to_yaml</span>
149:         <span class="ruby-identifier">open</span> <span class="ruby-identifier">yaml_name</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">yaml_zipped</span> <span class="ruby-keyword kw">end</span>
150: 
151:         <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">updated</span> <span class="ruby-identifier">original_name</span>
152:       <span class="ruby-keyword kw">end</span>
153: 
154:       <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">done</span>
155:     <span class="ruby-keyword kw">end</span>
156: 
157:     <span class="ruby-identifier">say</span> <span class="ruby-value str">&quot;Generating quick index&quot;</span>
158: 
159:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Generated quick index'</span> <span class="ruby-keyword kw">do</span>
160:       <span class="ruby-identifier">open</span> <span class="ruby-ivar">@quick_index</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
161:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">spec</span><span class="ruby-operator">|</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_name</span> }
162:       <span class="ruby-keyword kw">end</span>
163:     <span class="ruby-keyword kw">end</span>
164: 
165:     <span class="ruby-identifier">say</span> <span class="ruby-value str">&quot;Generating latest index&quot;</span>
166: 
167:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Generated latest index'</span> <span class="ruby-keyword kw">do</span>
168:       <span class="ruby-identifier">open</span> <span class="ruby-ivar">@latest_index</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
169:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">latest_specs</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_name</span> }
170:       <span class="ruby-keyword kw">end</span>
171:     <span class="ruby-keyword kw">end</span>
172: 
173:     <span class="ruby-comment cmt"># Don't need prerelease legacy index</span>
174: 
175:     <span class="ruby-identifier">say</span> <span class="ruby-value str">&quot;Generating Marshal master index&quot;</span>
176: 
177:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Generated Marshal master index'</span> <span class="ruby-keyword kw">do</span>
178:       <span class="ruby-identifier">open</span> <span class="ruby-ivar">@marshal_index</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
179:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">dump</span>
180:       <span class="ruby-keyword kw">end</span>
181:     <span class="ruby-keyword kw">end</span>
182: 
183:     <span class="ruby-identifier">progress</span> = <span class="ruby-identifier">ui</span>.<span class="ruby-identifier">progress_reporter</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">size</span>,
184:                                     <span class="ruby-node">&quot;Generating YAML master index for #{index.size} gems (this may take a while)&quot;</span>,
185:                                     <span class="ruby-value str">&quot;Complete&quot;</span>
186: 
187:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Generated YAML master index'</span> <span class="ruby-keyword kw">do</span>
188:       <span class="ruby-identifier">open</span> <span class="ruby-ivar">@master_index</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
189:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;--- !ruby/object:#{index.class}&quot;</span>
190:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;gems:&quot;</span>
191: 
192:         <span class="ruby-identifier">gems</span> = <span class="ruby-identifier">index</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">gemspec</span><span class="ruby-operator">|</span> <span class="ruby-identifier">gemspec</span>.<span class="ruby-identifier">sort_obj</span> }
193:         <span class="ruby-identifier">gems</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original_name</span>, <span class="ruby-identifier">gemspec</span><span class="ruby-operator">|</span>
194:           <span class="ruby-identifier">yaml</span> = <span class="ruby-identifier">gemspec</span>.<span class="ruby-identifier">to_yaml</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/^/</span>, <span class="ruby-value str">'    '</span>)
195:           <span class="ruby-identifier">yaml</span> = <span class="ruby-identifier">yaml</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp re">/\A    ---/</span>, <span class="ruby-value str">''</span>) <span class="ruby-comment cmt"># there's a needed extra ' ' here</span>
196:           <span class="ruby-identifier">io</span>.<span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  #{original_name}:&quot;</span>
197:           <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">yaml</span>
198: 
199:           <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">updated</span> <span class="ruby-identifier">original_name</span>
200:         <span class="ruby-keyword kw">end</span>
201:       <span class="ruby-keyword kw">end</span>
202: 
203:       <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">done</span>
204:     <span class="ruby-keyword kw">end</span>
205: 
206:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@quick_dir</span>
207:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@master_index</span>
208:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@master_index}.Z&quot;</span>
209:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@marshal_index</span>
210:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@marshal_index}.Z&quot;</span>
211:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005449">
                    
                    <a name="M005449"></a><b>build_marshal_gemspecs</b>(index)
                    
                </div>
                
                <div class="description">
                  <p>
Builds <a href="../Marshal.html">Marshal</a> quick index gemspecs.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005449_source')" id="l_M005449_source">show</a>
                        
                    </p>
                    <div id="M005449_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 216</span>
216:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_marshal_gemspecs</span>(<span class="ruby-identifier">index</span>)
217:     <span class="ruby-identifier">progress</span> = <span class="ruby-identifier">ui</span>.<span class="ruby-identifier">progress_reporter</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">size</span>,
218:                                     <span class="ruby-node">&quot;Generating Marshal quick index gemspecs for #{index.size} gems&quot;</span>,
219:                                     <span class="ruby-value str">&quot;Complete&quot;</span>
220: 
221:     <span class="ruby-identifier">files</span> = []
222: 
223:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Generated Marshal quick index gemspecs'</span> <span class="ruby-keyword kw">do</span>
224:       <span class="ruby-identifier">index</span>.<span class="ruby-identifier">gems</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original_name</span>, <span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
225:         <span class="ruby-identifier">spec_file_name</span> = <span class="ruby-node">&quot;#{original_name}.gemspec.rz&quot;</span>
226:         <span class="ruby-identifier">marshal_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_marshal_dir</span>, <span class="ruby-identifier">spec_file_name</span>
227: 
228:         <span class="ruby-identifier">marshal_zipped</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">deflate</span> <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">spec</span>)
229:         <span class="ruby-identifier">open</span> <span class="ruby-identifier">marshal_name</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">marshal_zipped</span> <span class="ruby-keyword kw">end</span>
230: 
231:         <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">marshal_name</span>
232: 
233:         <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">updated</span> <span class="ruby-identifier">original_name</span>
234:       <span class="ruby-keyword kw">end</span>
235: 
236:       <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">done</span>
237:     <span class="ruby-keyword kw">end</span>
238: 
239:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@quick_marshal_dir</span>
240: 
241:     <span class="ruby-identifier">files</span>
242:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005450">
                    
                    <a name="M005450"></a><b>build_modern_index</b>(index, file, name)
                    
                </div>
                
                <div class="description">
                  <p>
Build a single index for RubyGems 1.2 and newer
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005450_source')" id="l_M005450_source">show</a>
                        
                    </p>
                    <div id="M005450_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 247</span>
247:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">index</span>, <span class="ruby-identifier">file</span>, <span class="ruby-identifier">name</span>)
248:     <span class="ruby-identifier">say</span> <span class="ruby-node">&quot;Generating #{name} index&quot;</span>
249: 
250:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-node">&quot;Generated #{name} index&quot;</span> <span class="ruby-keyword kw">do</span>
251:       <span class="ruby-identifier">open</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value str">'wb'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
252:         <span class="ruby-identifier">specs</span> = <span class="ruby-identifier">index</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-operator">*</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
253:           <span class="ruby-comment cmt"># We have to splat here because latest_specs is an array,</span>
254:           <span class="ruby-comment cmt"># while the others are hashes. See the TODO in source_index.rb</span>
255:           <span class="ruby-identifier">spec</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">last</span>
256:           <span class="ruby-identifier">platform</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_platform</span>
257: 
258:           <span class="ruby-comment cmt"># win32-api-1.0.4-x86-mswin32-60</span>
259:           <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">platform</span> <span class="ruby-keyword kw">then</span>
260:             <span class="ruby-identifier">alert_warning</span> <span class="ruby-node">&quot;Skipping invalid platform in gem: #{spec.full_name}&quot;</span>
261:             <span class="ruby-keyword kw">next</span>
262:           <span class="ruby-keyword kw">end</span>
263: 
264:           <span class="ruby-identifier">platform</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Platform</span><span class="ruby-operator">::</span><span class="ruby-constant">RUBY</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">empty?</span>
265:           [<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">version</span>, <span class="ruby-identifier">platform</span>]
266:         <span class="ruby-keyword kw">end</span>
267: 
268:         <span class="ruby-identifier">specs</span> = <span class="ruby-identifier">compact_specs</span>(<span class="ruby-identifier">specs</span>)
269:         <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">specs</span>, <span class="ruby-identifier">io</span>)
270:       <span class="ruby-keyword kw">end</span>
271:     <span class="ruby-keyword kw">end</span>
272:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005451">
                    
                    <a name="M005451"></a><b>build_modern_indicies</b>(index)
                    
                </div>
                
                <div class="description">
                  <p>
Builds indicies for RubyGems 1.2 and newer. Handles full, latest,
prerelease
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005451_source')" id="l_M005451_source">show</a>
                        
                    </p>
                    <div id="M005451_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 277</span>
277:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_modern_indicies</span>(<span class="ruby-identifier">index</span>)
278:     <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">index</span>.<span class="ruby-identifier">released_specs</span>.<span class="ruby-identifier">sort</span>, <span class="ruby-ivar">@specs_index</span>, <span class="ruby-value str">'specs'</span>)
279:     <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">index</span>.<span class="ruby-identifier">latest_specs</span>.<span class="ruby-identifier">sort</span>,
280:                        <span class="ruby-ivar">@latest_specs_index</span>,
281:                        <span class="ruby-value str">'latest specs'</span>)
282:     <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">index</span>.<span class="ruby-identifier">prerelease_specs</span>.<span class="ruby-identifier">sort</span>,
283:                        <span class="ruby-ivar">@prerelease_specs_index</span>,
284:                        <span class="ruby-value str">'prerelease specs'</span>)
285: 
286:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">+=</span> [<span class="ruby-ivar">@specs_index</span>,
287:                <span class="ruby-node">&quot;#{@specs_index}.gz&quot;</span>,
288:                <span class="ruby-ivar">@latest_specs_index</span>,
289:                <span class="ruby-node">&quot;#{@latest_specs_index}.gz&quot;</span>,
290:                <span class="ruby-ivar">@prerelease_specs_index</span>,
291:                <span class="ruby-node">&quot;#{@prerelease_specs_index}.gz&quot;</span>]
292:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005452">
                    
                    <a name="M005452"></a><b>build_rss</b>(index)
                    
                </div>
                
                <div class="description">
                  <p>
Builds an RSS feed for past two days gem releases according to the
gem&#8217;s date.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005452_source')" id="l_M005452_source">show</a>
                        
                    </p>
                    <div id="M005452_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 298</span>
298:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_rss</span>(<span class="ruby-identifier">index</span>)
299:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rss_host</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-ivar">@rss_gems_host</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">then</span>
300:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">really_verbose</span> <span class="ruby-keyword kw">then</span>
301:         <span class="ruby-identifier">alert_warning</span> <span class="ruby-value str">&quot;no --rss-host or --rss-gems-host, RSS generation disabled&quot;</span>
302:       <span class="ruby-keyword kw">end</span>
303:       <span class="ruby-keyword kw">return</span>
304:     <span class="ruby-keyword kw">end</span>
305: 
306:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'cgi'</span>
307:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'rubygems/text'</span>
308: 
309:     <span class="ruby-identifier">extend</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Text</span>
310: 
311:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Generated rss'</span> <span class="ruby-keyword kw">do</span>
312:       <span class="ruby-identifier">open</span> <span class="ruby-ivar">@rss_index</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
313:         <span class="ruby-identifier">rss_host</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span> <span class="ruby-ivar">@rss_host</span>
314:         <span class="ruby-identifier">rss_title</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span>(<span class="ruby-ivar">@rss_title</span> <span class="ruby-operator">||</span> <span class="ruby-value str">'gems'</span>)
315: 
316:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&lt;rss version=\&quot;2.0\&quot;&gt;\n&lt;channel&gt;\n&lt;title&gt;\#{rss_title}&lt;/title&gt;\n&lt;link&gt;http://\#{rss_host}&lt;/link&gt;\n&lt;description&gt;Recently released gems from http://\#{rss_host}&lt;/description&gt;\n&lt;generator&gt;RubyGems v\#{Gem::VERSION}&lt;/generator&gt;\n&lt;docs&gt;http://cyber.law.harvard.edu/rss/rss.html&lt;/docs&gt;\n&quot;</span>
317: 
318:         <span class="ruby-identifier">today</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span><span class="ruby-operator">::</span><span class="ruby-constant">TODAY</span>
319:         <span class="ruby-identifier">yesterday</span> = <span class="ruby-identifier">today</span> <span class="ruby-operator">-</span> <span class="ruby-value">86400</span>
320: 
321:         <span class="ruby-identifier">index</span> = <span class="ruby-identifier">index</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
322:           <span class="ruby-identifier">spec_date</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">date</span>
323: 
324:           <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">spec_date</span>
325:           <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Date</span>
326:             <span class="ruby-constant">Time</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">spec_date</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">yesterday</span>
327:           <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Time</span>
328:             <span class="ruby-identifier">spec_date</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">yesterday</span>
329:           <span class="ruby-keyword kw">end</span>
330:         <span class="ruby-keyword kw">end</span>
331: 
332:         <span class="ruby-identifier">index</span> = <span class="ruby-identifier">index</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
333:           <span class="ruby-identifier">spec_date</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">date</span>
334: 
335:           <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">spec_date</span>
336:           <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Date</span>
337:             <span class="ruby-constant">Time</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">spec_date</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">today</span>
338:           <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Time</span>
339:             <span class="ruby-identifier">spec_date</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">today</span>
340:           <span class="ruby-keyword kw">end</span>
341:         <span class="ruby-keyword kw">end</span>
342: 
343:         <span class="ruby-identifier">index</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">spec</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">spec</span>.<span class="ruby-identifier">date</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">spec</span>] }.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
344:           <span class="ruby-identifier">gem_path</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span> <span class="ruby-node">&quot;http://#{@rss_gems_host}/gems/#{spec.file_name}&quot;</span>
345:           <span class="ruby-identifier">size</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">loaded_from</span>).<span class="ruby-identifier">size</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">next</span>
346: 
347:           <span class="ruby-identifier">description</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">description</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">summary</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>
348:           <span class="ruby-identifier">authors</span> = <span class="ruby-constant">Array</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">authors</span>
349:           <span class="ruby-identifier">emails</span> = <span class="ruby-constant">Array</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">email</span>
350:           <span class="ruby-identifier">authors</span> = <span class="ruby-identifier">emails</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">authors</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">email</span>, <span class="ruby-identifier">author</span><span class="ruby-operator">|</span>
351:             <span class="ruby-identifier">email</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; (#{author})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">author</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">author</span>.<span class="ruby-identifier">empty?</span>
352:           <span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">join</span> <span class="ruby-value str">', '</span>
353: 
354:           <span class="ruby-identifier">description</span> = <span class="ruby-identifier">description</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\n\n+/</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">chunk</span><span class="ruby-operator">|</span>
355:             <span class="ruby-identifier">format_text</span> <span class="ruby-identifier">chunk</span>, <span class="ruby-value">78</span>
356:           <span class="ruby-keyword kw">end</span>
357: 
358:           <span class="ruby-identifier">description</span> = <span class="ruby-identifier">description</span>.<span class="ruby-identifier">join</span> <span class="ruby-value str">&quot;\n\n&quot;</span>
359: 
360:           <span class="ruby-identifier">item</span> = <span class="ruby-value str">''</span>
361: 
362:           <span class="ruby-identifier">item</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;item&gt;\n&lt;title&gt;\#{CGI.escapeHTML spec.full_name}&lt;/title&gt;\n&lt;description&gt;\n&amp;lt;pre&amp;gt;\#{CGI.escapeHTML description.chomp}&amp;lt;/pre&amp;gt;\n&lt;/description&gt;\n&lt;author&gt;\#{CGI.escapeHTML authors}&lt;/author&gt;\n&lt;guid&gt;\#{CGI.escapeHTML spec.full_name}&lt;/guid&gt;\n&lt;enclosure url=\\\&quot;\#{gem_path}\\\&quot;\nlength=\\\&quot;\#{size}\\\&quot; type=\\\&quot;application/octet-stream\\\&quot; /&gt;\n&lt;pubDate&gt;\#{spec.date.rfc2822}&lt;/pubDate&gt;\n&quot;</span>
363: 
364:           <span class="ruby-identifier">item</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;link&gt;\#{CGI.escapeHTML spec.homepage}&lt;/link&gt;\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">homepage</span>
365: 
366:           <span class="ruby-identifier">item</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;/item&gt;\n&quot;</span>
367: 
368:           <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">item</span>
369:         <span class="ruby-keyword kw">end</span>
370: 
371:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;&lt;/channel&gt;\n&lt;/rss&gt;\n&quot;</span>
372:       <span class="ruby-keyword kw">end</span>
373:     <span class="ruby-keyword kw">end</span>
374: 
375:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@rss_index</span>
376:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005453">
                    
                    <a name="M005453"></a><b>collect_specs</b>(gems = gem_file_list)
                    
                </div>
                
                <div class="description">
                  <p>
Collect specifications from .gem files from the gem directory.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005453_source')" id="l_M005453_source">show</a>
                        
                    </p>
                    <div id="M005453_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 413</span>
413:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">collect_specs</span>(<span class="ruby-identifier">gems</span> = <span class="ruby-identifier">gem_file_list</span>)
414:     <span class="ruby-identifier">index</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">SourceIndex</span>.<span class="ruby-identifier">new</span>
415: 
416:     <span class="ruby-identifier">progress</span> = <span class="ruby-identifier">ui</span>.<span class="ruby-identifier">progress_reporter</span> <span class="ruby-identifier">gems</span>.<span class="ruby-identifier">size</span>,
417:                                     <span class="ruby-node">&quot;Loading #{gems.size} gems from #{@dest_directory}&quot;</span>,
418:                                     <span class="ruby-value str">&quot;Loaded all gems&quot;</span>
419: 
420:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'loaded'</span> <span class="ruby-keyword kw">do</span>
421:       <span class="ruby-identifier">gems</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gemfile</span><span class="ruby-operator">|</span>
422:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">size</span>(<span class="ruby-identifier">gemfile</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">then</span>
423:           <span class="ruby-identifier">alert_warning</span> <span class="ruby-node">&quot;Skipping zero-length gem: #{gemfile}&quot;</span>
424:           <span class="ruby-keyword kw">next</span>
425:         <span class="ruby-keyword kw">end</span>
426: 
427:         <span class="ruby-keyword kw">begin</span>
428:           <span class="ruby-identifier">spec</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">from_file_by_path</span>(<span class="ruby-identifier">gemfile</span>).<span class="ruby-identifier">spec</span>
429:           <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">loaded_from</span> = <span class="ruby-identifier">gemfile</span>
430: 
431:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">gemfile</span> <span class="ruby-operator">=~</span> <span class="ruby-node">/\/#{Regexp.escape spec.original_name}.*\.gem\z/i</span> <span class="ruby-keyword kw">then</span>
432:             <span class="ruby-identifier">expected_name</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">full_name</span>
433:             <span class="ruby-identifier">expected_name</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; (#{spec.original_name})&quot;</span> <span class="ruby-keyword kw">if</span>
434:               <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_name</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">full_name</span>
435:             <span class="ruby-identifier">alert_warning</span> <span class="ruby-node">&quot;Skipping misnamed gem: #{gemfile} should be named #{expected_name}&quot;</span>
436:             <span class="ruby-keyword kw">next</span>
437:           <span class="ruby-keyword kw">end</span>
438: 
439:           <span class="ruby-identifier">abbreviate</span> <span class="ruby-identifier">spec</span>
440:           <span class="ruby-identifier">sanitize</span> <span class="ruby-identifier">spec</span>
441: 
442:           <span class="ruby-identifier">index</span>.<span class="ruby-identifier">add_spec</span> <span class="ruby-identifier">spec</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_name</span>
443: 
444:           <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">updated</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_name</span>
445: 
446:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SignalException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
447:           <span class="ruby-identifier">alert_error</span> <span class="ruby-value str">&quot;Received signal, exiting&quot;</span>
448:           <span class="ruby-identifier">raise</span>
449:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
450:           <span class="ruby-identifier">alert_error</span> <span class="ruby-node">&quot;Unable to process #{gemfile}\n#{e.message} (#{e.class})\n\t#{e.backtrace.join &quot;\n\t&quot;}&quot;</span>
451:         <span class="ruby-keyword kw">end</span>
452:       <span class="ruby-keyword kw">end</span>
453: 
454:       <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">done</span>
455:     <span class="ruby-keyword kw">end</span>
456: 
457:     <span class="ruby-identifier">index</span>
458:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005455">
                    
                    <a name="M005455"></a><b>compact_specs</b>(specs)
                    
                </div>
                
                <div class="description">
                  <p>
Compacts <a href="../Marshal.html">Marshal</a> output for the specs index
data source by using identical objects as much as possible.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005455_source')" id="l_M005455_source">show</a>
                        
                    </p>
                    <div id="M005455_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 495</span>
495:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">compact_specs</span>(<span class="ruby-identifier">specs</span>)
496:     <span class="ruby-identifier">names</span> = {}
497:     <span class="ruby-identifier">versions</span> = {}
498:     <span class="ruby-identifier">platforms</span> = {}
499: 
500:     <span class="ruby-identifier">specs</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">version</span>, <span class="ruby-identifier">platform</span>)<span class="ruby-operator">|</span>
501:       <span class="ruby-identifier">names</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">names</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">name</span>
502:       <span class="ruby-identifier">versions</span>[<span class="ruby-identifier">version</span>] = <span class="ruby-identifier">version</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">versions</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">version</span>
503:       <span class="ruby-identifier">platforms</span>[<span class="ruby-identifier">platform</span>] = <span class="ruby-identifier">platform</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">platforms</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">platform</span>
504: 
505:       [<span class="ruby-identifier">names</span>[<span class="ruby-identifier">name</span>], <span class="ruby-identifier">versions</span>[<span class="ruby-identifier">version</span>], <span class="ruby-identifier">platforms</span>[<span class="ruby-identifier">platform</span>]]
506:     <span class="ruby-keyword kw">end</span>
507:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005456">
                    
                    <a name="M005456"></a><b>compress</b>(filename, extension)
                    
                </div>
                
                <div class="description">
                  <p>
Compress <tt>filename</tt> with <tt>extension</tt>.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005456_source')" id="l_M005456_source">show</a>
                        
                    </p>
                    <div id="M005456_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 512</span>
512:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">compress</span>(<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">extension</span>)
513:     <span class="ruby-identifier">data</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span> <span class="ruby-identifier">filename</span>
514: 
515:     <span class="ruby-identifier">zipped</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">deflate</span> <span class="ruby-identifier">data</span>
516: 
517:     <span class="ruby-identifier">open</span> <span class="ruby-node">&quot;#{filename}.#{extension}&quot;</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
518:       <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">zipped</span>
519:     <span class="ruby-keyword kw">end</span>
520:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005454">
                    
                    <a name="M005454"></a><b>compress_indicies</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Compresses indicies on disk
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005454_source')" id="l_M005454_source">show</a>
                        
                    </p>
                    <div id="M005454_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 465</span>
465:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">compress_indicies</span>
466:     <span class="ruby-identifier">say</span> <span class="ruby-value str">&quot;Compressing indicies&quot;</span>
467: 
468:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Compressed indicies'</span> <span class="ruby-keyword kw">do</span>
469:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@build_legacy</span> <span class="ruby-keyword kw">then</span>
470:         <span class="ruby-identifier">compress</span> <span class="ruby-ivar">@quick_index</span>, <span class="ruby-value str">'rz'</span>
471:         <span class="ruby-identifier">paranoid</span> <span class="ruby-ivar">@quick_index</span>, <span class="ruby-value str">'rz'</span>
472: 
473:         <span class="ruby-identifier">compress</span> <span class="ruby-ivar">@latest_index</span>, <span class="ruby-value str">'rz'</span>
474:         <span class="ruby-identifier">paranoid</span> <span class="ruby-ivar">@latest_index</span>, <span class="ruby-value str">'rz'</span>
475: 
476:         <span class="ruby-identifier">compress</span> <span class="ruby-ivar">@marshal_index</span>, <span class="ruby-value str">'Z'</span>
477:         <span class="ruby-identifier">paranoid</span> <span class="ruby-ivar">@marshal_index</span>, <span class="ruby-value str">'Z'</span>
478: 
479:         <span class="ruby-identifier">compress</span> <span class="ruby-ivar">@master_index</span>, <span class="ruby-value str">'Z'</span>
480:         <span class="ruby-identifier">paranoid</span> <span class="ruby-ivar">@master_index</span>, <span class="ruby-value str">'Z'</span>
481:       <span class="ruby-keyword kw">end</span>
482: 
483:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@build_modern</span> <span class="ruby-keyword kw">then</span>
484:         <span class="ruby-identifier">gzip</span> <span class="ruby-ivar">@specs_index</span>
485:         <span class="ruby-identifier">gzip</span> <span class="ruby-ivar">@latest_specs_index</span>
486:         <span class="ruby-identifier">gzip</span> <span class="ruby-ivar">@prerelease_specs_index</span>
487:       <span class="ruby-keyword kw">end</span>
488:     <span class="ruby-keyword kw">end</span>
489:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005457">
                    
                    <a name="M005457"></a><b>gem_file_list</b>()
                    
                </div>
                
                <div class="description">
                  <p>
<a href="../List.html">List</a> of gem file names to index.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005457_source')" id="l_M005457_source">show</a>
                        
                    </p>
                    <div id="M005457_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 525</span>
525:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gem_file_list</span>
526:     <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">glob</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-value str">&quot;gems&quot;</span>, <span class="ruby-value str">&quot;*.gem&quot;</span>))
527:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005458">
                    
                    <a name="M005458"></a><b>generate_index</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Builds and installs indicies.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005458_source')" id="l_M005458_source">show</a>
                        
                    </p>
                    <div id="M005458_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 532</span>
532:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate_index</span>
533:     <span class="ruby-identifier">make_temp_directories</span>
534:     <span class="ruby-identifier">index</span> = <span class="ruby-identifier">collect_specs</span>
535:     <span class="ruby-identifier">build_indicies</span> <span class="ruby-identifier">index</span>
536:     <span class="ruby-identifier">install_indicies</span>
537:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SignalException</span>
538:   <span class="ruby-keyword kw">ensure</span>
539:     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-ivar">@directory</span>
540:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005459">
                    
                    <a name="M005459"></a><b>gzip</b>(filename)
                    
                </div>
                
                <div class="description">
                  <p>
<a href="../Zlib/GzipWriter.html">Zlib::GzipWriter</a> wrapper that gzips
<tt>filename</tt> on disk.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005459_source')" id="l_M005459_source">show</a>
                        
                    </p>
                    <div id="M005459_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 545</span>
545:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gzip</span>(<span class="ruby-identifier">filename</span>)
546:     <span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">GzipWriter</span>.<span class="ruby-identifier">open</span> <span class="ruby-node">&quot;#{filename}.gz&quot;</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
547:       <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span>(<span class="ruby-identifier">filename</span>)
548:     <span class="ruby-keyword kw">end</span>
549:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005460">
                    
                    <a name="M005460"></a><b>install_indicies</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Install generated indicies into the destination directory.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005460_source')" id="l_M005460_source">show</a>
                        
                    </p>
                    <div id="M005460_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 554</span>
554:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">install_indicies</span>
555:     <span class="ruby-identifier">verbose</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">really_verbose</span>
556: 
557:     <span class="ruby-identifier">say</span> <span class="ruby-node">&quot;Moving index into production dir #{@dest_directory}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">verbose</span>
558: 
559:     <span class="ruby-identifier">files</span> = <span class="ruby-ivar">@files</span>.<span class="ruby-identifier">dup</span>
560:     <span class="ruby-identifier">files</span>.<span class="ruby-identifier">delete</span> <span class="ruby-ivar">@quick_marshal_dir</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">files</span>.<span class="ruby-identifier">include?</span> <span class="ruby-ivar">@quick_dir</span>
561: 
562:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">files</span>.<span class="ruby-identifier">include?</span> <span class="ruby-ivar">@quick_marshal_dir</span> <span class="ruby-keyword kw">and</span>
563:        <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">files</span>.<span class="ruby-identifier">include?</span> <span class="ruby-ivar">@quick_dir</span> <span class="ruby-keyword kw">then</span>
564:       <span class="ruby-identifier">files</span>.<span class="ruby-identifier">delete</span> <span class="ruby-ivar">@quick_marshal_dir</span>
565:       <span class="ruby-identifier">quick_marshal_dir</span> = <span class="ruby-ivar">@quick_marshal_dir</span>.<span class="ruby-identifier">sub</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-value str">''</span>
566: 
567:       <span class="ruby-identifier">dst_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@dest_directory</span>, <span class="ruby-identifier">quick_marshal_dir</span>
568: 
569:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">dst_name</span>), <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>
570:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-identifier">dst_name</span>, <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>
571:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span> <span class="ruby-ivar">@quick_marshal_dir</span>, <span class="ruby-identifier">dst_name</span>, <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>,
572:                    <span class="ruby-identifier">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
573:     <span class="ruby-keyword kw">end</span>
574: 
575:     <span class="ruby-identifier">files</span> = <span class="ruby-identifier">files</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
576:       <span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-value str">''</span>
577:     <span class="ruby-keyword kw">end</span>
578: 
579:     <span class="ruby-identifier">files</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
580:       <span class="ruby-identifier">src_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">file</span>
581:       <span class="ruby-identifier">dst_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@dest_directory</span>, <span class="ruby-identifier">file</span>
582: 
583:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-identifier">dst_name</span>, <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>
584:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span> <span class="ruby-identifier">src_name</span>, <span class="ruby-ivar">@dest_directory</span>, <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>,
585:                    <span class="ruby-identifier">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
586:     <span class="ruby-keyword kw">end</span>
587:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005476">
                    
                    <a name="M005476"></a><b>make_temp_directories</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Make directories for index generation
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005476_source')" id="l_M005476_source">show</a>
                        
                    </p>
                    <div id="M005476_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 592</span>
592:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">make_temp_directories</span>
593:     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-ivar">@directory</span>
594:     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">:mode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0700</span>
595:     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-ivar">@quick_marshal_dir</span>
596:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005477">
                    
                    <a name="M005477"></a><b>paranoid</b>(path, extension)
                    
                </div>
                
                <div class="description">
                  <p>
Ensure <tt>path</tt> and path with <tt>extension</tt> are identical.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005477_source')" id="l_M005477_source">show</a>
                        
                    </p>
                    <div id="M005477_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 601</span>
601:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">paranoid</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">extension</span>)
602:     <span class="ruby-identifier">data</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span> <span class="ruby-identifier">path</span>
603:     <span class="ruby-identifier">compressed_data</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span> <span class="ruby-node">&quot;#{path}.#{extension}&quot;</span>
604: 
605:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">inflate</span>(<span class="ruby-identifier">compressed_data</span>) <span class="ruby-keyword kw">then</span>
606:       <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Compressed file #{compressed_path} does not match uncompressed file #{path}&quot;</span>
607:     <span class="ruby-keyword kw">end</span>
608:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005478">
                    
                    <a name="M005478"></a><b>sanitize</b>(spec)
                    
                </div>
                
                <div class="description">
                  <p>
Sanitize the descriptive fields in the spec. Sometimes non-ASCII characters
will garble the site index. Non-ASCII characters will be replaced by their
XML entity equivalent.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005478_source')" id="l_M005478_source">show</a>
                        
                    </p>
                    <div id="M005478_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 615</span>
615:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sanitize</span>(<span class="ruby-identifier">spec</span>)
616:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">summary</span> = <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">summary</span>)
617:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">description</span> = <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">description</span>)
618:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">post_install_message</span> = <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">post_install_message</span>)
619:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">authors</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">authors</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">a</span>) }
620: 
621:     <span class="ruby-identifier">spec</span>
622:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005479">
                    
                    <a name="M005479"></a><b>sanitize_string</b>(string)
                    
                </div>
                
                <div class="description">
                  <p>
Sanitize a single string.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005479_source')" id="l_M005479_source">show</a>
                        
                    </p>
                    <div id="M005479_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 627</span>
627:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">string</span>)
628:     <span class="ruby-comment cmt"># HACK the #to_s is in here because RSpec has an Array of Arrays of</span>
629:     <span class="ruby-comment cmt"># Strings for authors.  Need a way to disallow bad values on gempsec</span>
630:     <span class="ruby-comment cmt"># generation.  (Probably won't happen.)</span>
631:     <span class="ruby-identifier">string</span> <span class="ruby-value">? </span><span class="ruby-identifier">string</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_xs</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">string</span>
632:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005480">
                    
                    <a name="M005480"></a><b>update_index</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Perform an in-place update of the repository from newly added gems. Only
works for modern indicies, and sets <a
href="Indexer.html#build_legacy">build_legacy</a> to false when run.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005480_source')" id="l_M005480_source">show</a>
                        
                    </p>
                    <div id="M005480_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 638</span>
638:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_index</span>
639:     <span class="ruby-ivar">@build_legacy</span> = <span class="ruby-keyword kw">false</span>
640: 
641:     <span class="ruby-identifier">make_temp_directories</span>
642: 
643:     <span class="ruby-identifier">specs_mtime</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-ivar">@dest_specs_index</span>).<span class="ruby-identifier">mtime</span>
644:     <span class="ruby-identifier">newest_mtime</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span> <span class="ruby-value">0</span>
645: 
646:     <span class="ruby-identifier">updated_gems</span> = <span class="ruby-identifier">gem_file_list</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gem</span><span class="ruby-operator">|</span>
647:       <span class="ruby-identifier">gem_mtime</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-identifier">gem</span>).<span class="ruby-identifier">mtime</span>
648:       <span class="ruby-identifier">newest_mtime</span> = <span class="ruby-identifier">gem_mtime</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">gem_mtime</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">newest_mtime</span>
649:       <span class="ruby-identifier">gem_mtime</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">specs_mtime</span>
650:     <span class="ruby-keyword kw">end</span>
651: 
652:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">updated_gems</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword kw">then</span>
653:       <span class="ruby-identifier">say</span> <span class="ruby-value str">'No new gems'</span>
654:       <span class="ruby-identifier">terminate_interaction</span> <span class="ruby-value">0</span>
655:     <span class="ruby-keyword kw">end</span>
656: 
657:     <span class="ruby-identifier">index</span> = <span class="ruby-identifier">collect_specs</span> <span class="ruby-identifier">updated_gems</span>
658: 
659:     <span class="ruby-identifier">files</span> = <span class="ruby-identifier">build_marshal_gemspecs</span> <span class="ruby-identifier">index</span>
660: 
661:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Updated indexes'</span> <span class="ruby-keyword kw">do</span>
662:       <span class="ruby-identifier">update_specs_index</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">released_gems</span>, <span class="ruby-ivar">@dest_specs_index</span>, <span class="ruby-ivar">@specs_index</span>
663:       <span class="ruby-identifier">update_specs_index</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">released_gems</span>, <span class="ruby-ivar">@dest_latest_specs_index</span>, <span class="ruby-ivar">@latest_specs_index</span>
664:       <span class="ruby-identifier">update_specs_index</span>(<span class="ruby-identifier">index</span>.<span class="ruby-identifier">prerelease_gems</span>, <span class="ruby-ivar">@dest_prerelease_specs_index</span>,
665:                          <span class="ruby-ivar">@prerelease_specs_index</span>)
666:     <span class="ruby-keyword kw">end</span>
667: 
668:     <span class="ruby-identifier">compress_indicies</span>
669: 
670:     <span class="ruby-identifier">verbose</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">really_verbose</span>
671: 
672:     <span class="ruby-identifier">say</span> <span class="ruby-node">&quot;Updating production dir #{@dest_directory}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">verbose</span>
673: 
674:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@specs_index</span>
675:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@specs_index}.gz&quot;</span>
676:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@latest_specs_index</span>
677:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@latest_specs_index}.gz&quot;</span>
678:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@prerelease_specs_index</span>
679:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@prerelease_specs_index}.gz&quot;</span>
680: 
681:     <span class="ruby-identifier">files</span> = <span class="ruby-identifier">files</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
682:       <span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-value str">''</span>
683:     <span class="ruby-keyword kw">end</span>
684: 
685:     <span class="ruby-identifier">files</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
686:       <span class="ruby-identifier">src_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">file</span>
687:       <span class="ruby-identifier">dst_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@dest_directory</span>, <span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">file</span>)
688: 
689:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span> <span class="ruby-identifier">src_name</span>, <span class="ruby-identifier">dst_name</span>, <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>,
690:                    <span class="ruby-identifier">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
691: 
692:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">utime</span> <span class="ruby-identifier">newest_mtime</span>, <span class="ruby-identifier">newest_mtime</span>, <span class="ruby-identifier">dst_name</span>
693:     <span class="ruby-keyword kw">end</span>
694:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M005481">
                    
                    <a name="M005481"></a><b>update_specs_index</b>(index, source, dest)
                    
                </div>
                
                <div class="description">
                  <p>
Combines specs in <tt>index</tt> and <tt>source</tt> then writes out a new
copy to <tt>dest</tt>. For a latest index, does not ensure the new file is
minimal.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M005481_source')" id="l_M005481_source">show</a>
                        
                    </p>
                    <div id="M005481_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 700</span>
700:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_specs_index</span>(<span class="ruby-identifier">index</span>, <span class="ruby-identifier">source</span>, <span class="ruby-identifier">dest</span>)
701:     <span class="ruby-identifier">specs_index</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span>(<span class="ruby-identifier">source</span>)
702: 
703:     <span class="ruby-identifier">index</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">_</span>, <span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
704:       <span class="ruby-identifier">platform</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_platform</span>
705:       <span class="ruby-identifier">platform</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Platform</span><span class="ruby-operator">::</span><span class="ruby-constant">RUBY</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">empty?</span>
706:       <span class="ruby-identifier">specs_index</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">version</span>, <span class="ruby-identifier">platform</span>]
707:     <span class="ruby-keyword kw">end</span>
708: 
709:     <span class="ruby-identifier">specs_index</span> = <span class="ruby-identifier">compact_specs</span> <span class="ruby-identifier">specs_index</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>
710: 
711:     <span class="ruby-identifier">open</span> <span class="ruby-identifier">dest</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
712:       <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span> <span class="ruby-identifier">specs_index</span>, <span class="ruby-identifier">io</span>
713:     <span class="ruby-keyword kw">end</span>
714:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    