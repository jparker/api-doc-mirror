<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Shell::ProcessController</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            Shell::ProcessController 
            
                <span class="parent">&lt; 
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/shell/process-controller_rb.html">lib/shell/process-controller.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>A</dt>
        <dd>
            <ul>
                
                <li><a href="#M001829">activate</a>,</li>
                
                <li><a href="#M001844">active_job?</a>,</li>
                
                <li><a href="#M001836">active_jobs</a>,</li>
                
                <li><a href="#M001839">active_jobs_exist?</a>,</li>
                
                <li><a href="#M001828">active_process_controllers</a>,</li>
                
                <li><a href="#M001841">add_schedule</a></li>
                
            </ul>
        </dd>
    
        <dt>B</dt>
        <dd>
            <ul>
                
                <li><a href="#M001832">block_output_synchronize</a></li>
                
            </ul>
        </dd>
    
        <dt>E</dt>
        <dd>
            <ul>
                
                <li><a href="#M001831">each_active_object</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M001830">inactivate</a></li>
                
            </ul>
        </dd>
    
        <dt>J</dt>
        <dd>
            <ul>
                
                <li><a href="#M001835">jobs</a>,</li>
                
                <li><a href="#M001838">jobs_exist?</a></li>
                
            </ul>
        </dd>
    
        <dt>K</dt>
        <dd>
            <ul>
                
                <li><a href="#M001846">kill_job</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M001834">new</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M001848">sfork</a>,</li>
                
                <li><a href="#M001842">start_job</a></li>
                
            </ul>
        </dd>
    
        <dt>T</dt>
        <dd>
            <ul>
                
                <li><a href="#M001845">terminate_job</a></li>
                
            </ul>
        </dd>
    
        <dt>W</dt>
        <dd>
            <ul>
                
                <li><a href="#M001847">wait_all_jobs_execution</a>,</li>
                
                <li><a href="#M001833">wait_to_finish_all_process_controllers</a>,</li>
                
                <li><a href="#M001843">waiting_job?</a>,</li>
                
                <li><a href="#M001837">waiting_jobs</a>,</li>
                
                <li><a href="#M001840">waiting_jobs_exist?</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">USING_AT_EXIT_WHEN_PROCESS_EXIT</td>
            <td>=</td>
            <td class="attr-value">true</td>
        </tr>
        
        <tr valign='top'>
            <td>&nbsp;</td>
            <td colspan="2" class="attr-desc"><p>
for shell-command complete finish at this process exit.
</p>
</td>
        </tr>
        
        
    </table>
    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>shell</td>
            <td class='attr-desc'></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M001829">
                    
                    <a name="M001829"></a><b>activate</b>(pc)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001829_source')" id="l_M001829_source">show</a>
                        
                    </p>
                    <div id="M001829_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 38</span>
38:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">activate</span>(<span class="ruby-identifier">pc</span>)
39:         <span class="ruby-identifier">process_controllers_exclusive</span> <span class="ruby-keyword kw">do</span>
40:           <span class="ruby-ivar">@ProcessControllers</span>[<span class="ruby-identifier">pc</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
41:           <span class="ruby-ivar">@ProcessControllers</span>[<span class="ruby-identifier">pc</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
42:         <span class="ruby-keyword kw">end</span>
43:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001828">
                    
                    <a name="M001828"></a><b>active_process_controllers</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001828_source')" id="l_M001828_source">show</a>
                        
                    </p>
                    <div id="M001828_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 32</span>
32:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">active_process_controllers</span>
33:         <span class="ruby-identifier">process_controllers_exclusive</span> <span class="ruby-keyword kw">do</span>
34:           <span class="ruby-ivar">@ProcessControllers</span>.<span class="ruby-identifier">dup</span>
35:         <span class="ruby-keyword kw">end</span>
36:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001832">
                    
                    <a name="M001832"></a><b>block_output_synchronize</b>(&amp;b)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001832_source')" id="l_M001832_source">show</a>
                        
                    </p>
                    <div id="M001832_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 64</span>
64:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">block_output_synchronize</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">b</span>)
65:         <span class="ruby-ivar">@BlockOutputMonitor</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">b</span>)
66:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001831">
                    
                    <a name="M001831"></a><b>each_active_object</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001831_source')" id="l_M001831_source">show</a>
                        
                    </p>
                    <div id="M001831_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 56</span>
56:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">each_active_object</span>
57:         <span class="ruby-identifier">process_controllers_exclusive</span> <span class="ruby-keyword kw">do</span>
58:           <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">ref</span> <span class="ruby-keyword kw">in</span> <span class="ruby-ivar">@ProcessControllers</span>.<span class="ruby-identifier">keys</span>
59:             <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">ref</span>
60:           <span class="ruby-keyword kw">end</span>
61:         <span class="ruby-keyword kw">end</span>
62:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001830">
                    
                    <a name="M001830"></a><b>inactivate</b>(pc)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001830_source')" id="l_M001830_source">show</a>
                        
                    </p>
                    <div id="M001830_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 45</span>
45:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">inactivate</span>(<span class="ruby-identifier">pc</span>)
46:         <span class="ruby-identifier">process_controllers_exclusive</span> <span class="ruby-keyword kw">do</span>
47:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@ProcessControllers</span>[<span class="ruby-identifier">pc</span>]
48:             <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@ProcessControllers</span>[<span class="ruby-identifier">pc</span>] <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
49:               <span class="ruby-ivar">@ProcessControllers</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">pc</span>)
50:               <span class="ruby-ivar">@ProcessControllersCV</span>.<span class="ruby-identifier">signal</span>
51:             <span class="ruby-keyword kw">end</span>
52:           <span class="ruby-keyword kw">end</span>
53:         <span class="ruby-keyword kw">end</span>
54:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001834">
                    
                    <a name="M001834"></a><b>new</b>(shell)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001834_source')" id="l_M001834_source">show</a>
                        
                    </p>
                    <div id="M001834_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 93</span>
 93:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">shell</span>)
 94:       <span class="ruby-ivar">@shell</span> = <span class="ruby-identifier">shell</span>
 95:       <span class="ruby-ivar">@waiting_jobs</span> = []
 96:       <span class="ruby-ivar">@active_jobs</span> = []
 97:       <span class="ruby-ivar">@jobs_sync</span> = <span class="ruby-constant">Sync</span>.<span class="ruby-identifier">new</span>
 98: 
 99:       <span class="ruby-ivar">@job_monitor</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
100:       <span class="ruby-ivar">@job_condition</span> = <span class="ruby-constant">ConditionVariable</span>.<span class="ruby-identifier">new</span>
101:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001833">
                    
                    <a name="M001833"></a><b>wait_to_finish_all_process_controllers</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001833_source')" id="l_M001833_source">show</a>
                        
                    </p>
                    <div id="M001833_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 68</span>
68:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wait_to_finish_all_process_controllers</span>
69:         <span class="ruby-identifier">process_controllers_exclusive</span> <span class="ruby-keyword kw">do</span>
70:           <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@ProcessControllers</span>.<span class="ruby-identifier">empty?</span>
71:             <span class="ruby-constant">Shell</span><span class="ruby-operator">::</span><span class="ruby-identifier">notify</span>(<span class="ruby-value str">&quot;Process finishing, but active shell exists&quot;</span>,
72:                           <span class="ruby-value str">&quot;You can use Shell#transact or Shell#check_point for more safe execution.&quot;</span>)
73:             <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Shell</span>.<span class="ruby-identifier">debug?</span>
74:               <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">pc</span> <span class="ruby-keyword kw">in</span> <span class="ruby-ivar">@ProcessControllers</span>.<span class="ruby-identifier">keys</span>
75:                 <span class="ruby-constant">Shell</span><span class="ruby-operator">::</span><span class="ruby-identifier">notify</span>(<span class="ruby-value str">&quot; Not finished jobs in &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">pc</span>.<span class="ruby-identifier">shell</span>.<span class="ruby-identifier">to_s</span>)
76:                 <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">com</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">pc</span>.<span class="ruby-identifier">jobs</span>
77:                   <span class="ruby-identifier">com</span>.<span class="ruby-identifier">notify</span>(<span class="ruby-value str">&quot;  Jobs: %id&quot;</span>)
78:                 <span class="ruby-keyword kw">end</span>
79:               <span class="ruby-keyword kw">end</span>
80:             <span class="ruby-keyword kw">end</span>
81:             <span class="ruby-ivar">@ProcessControllersCV</span>.<span class="ruby-identifier">wait</span>(<span class="ruby-ivar">@ProcessControllersMonitor</span>)
82:           <span class="ruby-keyword kw">end</span>
83:         <span class="ruby-keyword kw">end</span>
84:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M001844">
                    
                    <a name="M001844"></a><b>active_job?</b>(job)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001844_source')" id="l_M001844_source">show</a>
                        
                    </p>
                    <div id="M001844_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 182</span>
182:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">active_job?</span>(<span class="ruby-identifier">job</span>)
183:       <span class="ruby-ivar">@jobs_sync</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">:SH</span>) <span class="ruby-keyword kw">do</span>
184:         <span class="ruby-ivar">@active_jobs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">job</span>)
185:       <span class="ruby-keyword kw">end</span>
186:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001836">
                    
                    <a name="M001836"></a><b>active_jobs</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001836_source')" id="l_M001836_source">show</a>
                        
                    </p>
                    <div id="M001836_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 114</span>
114:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">active_jobs</span>
115:       <span class="ruby-ivar">@active_jobs</span>
116:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001839">
                    
                    <a name="M001839"></a><b>active_jobs_exist?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001839_source')" id="l_M001839_source">show</a>
                        
                    </p>
                    <div id="M001839_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 128</span>
128:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">active_jobs_exist?</span>
129:       <span class="ruby-ivar">@jobs_sync</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">:SH</span>) <span class="ruby-keyword kw">do</span>
130:         <span class="ruby-ivar">@active_jobs</span>.<span class="ruby-identifier">empty?</span>
131:       <span class="ruby-keyword kw">end</span>
132:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001841">
                    
                    <a name="M001841"></a><b>add_schedule</b>(command)
                    
                </div>
                
                <div class="description">
                  <p>
schedule a command
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001841_source')" id="l_M001841_source">show</a>
                        
                    </p>
                    <div id="M001841_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 141</span>
141:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_schedule</span>(<span class="ruby-identifier">command</span>)
142:       <span class="ruby-ivar">@jobs_sync</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">:EX</span>) <span class="ruby-keyword kw">do</span>
143:         <span class="ruby-constant">ProcessController</span>.<span class="ruby-identifier">activate</span>(<span class="ruby-keyword kw">self</span>)
144:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@active_jobs</span>.<span class="ruby-identifier">empty?</span>
145:           <span class="ruby-identifier">start_job</span> <span class="ruby-identifier">command</span>
146:         <span class="ruby-keyword kw">else</span>
147:           <span class="ruby-ivar">@waiting_jobs</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">command</span>)
148:         <span class="ruby-keyword kw">end</span>
149:       <span class="ruby-keyword kw">end</span>
150:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001835">
                    
                    <a name="M001835"></a><b>jobs</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001835_source')" id="l_M001835_source">show</a>
                        
                    </p>
                    <div id="M001835_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 105</span>
105:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">jobs</span>
106:       <span class="ruby-identifier">jobs</span> = []
107:       <span class="ruby-ivar">@jobs_sync</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">:SH</span>) <span class="ruby-keyword kw">do</span>
108:         <span class="ruby-identifier">jobs</span>.<span class="ruby-identifier">concat</span> <span class="ruby-ivar">@waiting_jobs</span>
109:         <span class="ruby-identifier">jobs</span>.<span class="ruby-identifier">concat</span> <span class="ruby-ivar">@active_jobs</span>
110:       <span class="ruby-keyword kw">end</span>
111:       <span class="ruby-identifier">jobs</span>
112:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001838">
                    
                    <a name="M001838"></a><b>jobs_exist?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001838_source')" id="l_M001838_source">show</a>
                        
                    </p>
                    <div id="M001838_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 122</span>
122:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">jobs_exist?</span>
123:       <span class="ruby-ivar">@jobs_sync</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">:SH</span>) <span class="ruby-keyword kw">do</span>
124:         <span class="ruby-ivar">@active_jobs</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-ivar">@waiting_jobs</span>.<span class="ruby-identifier">empty?</span>
125:       <span class="ruby-keyword kw">end</span>
126:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001846">
                    
                    <a name="M001846"></a><b>kill_job</b>(sig, command)
                    
                </div>
                
                <div class="description">
                  <p>
kill a job
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001846_source')" id="l_M001846_source">show</a>
                        
                    </p>
                    <div id="M001846_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 201</span>
201:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">kill_job</span>(<span class="ruby-identifier">sig</span>, <span class="ruby-identifier">command</span>)
202:       <span class="ruby-ivar">@jobs_sync</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">:EX</span>) <span class="ruby-keyword kw">do</span>
203:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@waiting_jobs</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">command</span>
204:           <span class="ruby-constant">ProcessController</span>.<span class="ruby-identifier">inactivate</span>(<span class="ruby-keyword kw">self</span>)
205:           <span class="ruby-keyword kw">return</span>
206:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@active_jobs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">command</span>)
207:           <span class="ruby-keyword kw">begin</span>
208:             <span class="ruby-identifier">r</span> = <span class="ruby-identifier">command</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-identifier">sig</span>)
209:             <span class="ruby-constant">ProcessController</span>.<span class="ruby-identifier">inactivate</span>(<span class="ruby-keyword kw">self</span>)
210:           <span class="ruby-keyword kw">rescue</span>
211:             <span class="ruby-identifier">print</span> <span class="ruby-value str">&quot;Shell: Warn: $!\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@shell</span>.<span class="ruby-identifier">verbose?</span>
212:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
213:           <span class="ruby-keyword kw">end</span>
214:           <span class="ruby-ivar">@active_jobs</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">command</span>
215:           <span class="ruby-identifier">r</span>
216:         <span class="ruby-keyword kw">end</span>
217:       <span class="ruby-keyword kw">end</span>
218:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001848">
                    
                    <a name="M001848"></a><b>sfork</b>(command, &amp;block)
                    
                </div>
                
                <div class="description">
                  <p>
simple fork
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001848_source')" id="l_M001848_source">show</a>
                        
                    </p>
                    <div id="M001848_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 237</span>
237:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sfork</span>(<span class="ruby-identifier">command</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
238:       <span class="ruby-identifier">pipe_me_in</span>, <span class="ruby-identifier">pipe_peer_out</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
239:       <span class="ruby-identifier">pipe_peer_in</span>, <span class="ruby-identifier">pipe_me_out</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
240: 
241: 
242:       <span class="ruby-identifier">pid</span> = <span class="ruby-keyword kw">nil</span>
243:       <span class="ruby-identifier">pid_mutex</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
244:       <span class="ruby-identifier">pid_cv</span> = <span class="ruby-constant">ConditionVariable</span>.<span class="ruby-identifier">new</span>
245: 
246:       <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">start</span> <span class="ruby-keyword kw">do</span>
247:         <span class="ruby-constant">ProcessController</span>.<span class="ruby-identifier">block_output_synchronize</span> <span class="ruby-keyword kw">do</span>
248:           <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">flush</span>
249:           <span class="ruby-constant">ProcessController</span>.<span class="ruby-identifier">each_active_object</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pc</span><span class="ruby-operator">|</span>
250:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">jobs</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">pc</span>.<span class="ruby-identifier">active_jobs</span>
251:               <span class="ruby-identifier">jobs</span>.<span class="ruby-identifier">flush</span>
252:             <span class="ruby-keyword kw">end</span>
253:           <span class="ruby-keyword kw">end</span>
254: 
255:           <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">fork</span> {
256:             <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">list</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">th</span><span class="ruby-operator">|</span>
257: <span class="ruby-comment cmt">#             th.kill unless [Thread.main, Thread.current].include?(th)</span>
258:               <span class="ruby-identifier">th</span>.<span class="ruby-identifier">kill</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
259:             <span class="ruby-keyword kw">end</span>
260: 
261:             <span class="ruby-constant">STDIN</span>.<span class="ruby-identifier">reopen</span>(<span class="ruby-identifier">pipe_peer_in</span>)
262:             <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">reopen</span>(<span class="ruby-identifier">pipe_peer_out</span>)
263: 
264:             <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span>(<span class="ruby-constant">IO</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
265:               <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>[<span class="ruby-constant">STDIN</span>, <span class="ruby-constant">STDOUT</span>, <span class="ruby-constant">STDERR</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">io</span>)
266:                 <span class="ruby-identifier">io</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">closed?</span>
267:               <span class="ruby-keyword kw">end</span>
268:             <span class="ruby-keyword kw">end</span>
269: 
270:             <span class="ruby-keyword kw">yield</span>
271:           }
272:         <span class="ruby-keyword kw">end</span>
273:         <span class="ruby-identifier">pid_cv</span>.<span class="ruby-identifier">signal</span>
274: 
275:         <span class="ruby-identifier">pipe_peer_in</span>.<span class="ruby-identifier">close</span>
276:         <span class="ruby-identifier">pipe_peer_out</span>.<span class="ruby-identifier">close</span>
277:         <span class="ruby-identifier">command</span>.<span class="ruby-identifier">notify</span> <span class="ruby-node">&quot;job(%name:##{pid}) start&quot;</span>, <span class="ruby-ivar">@shell</span>.<span class="ruby-identifier">debug?</span>
278: 
279:         <span class="ruby-keyword kw">begin</span>
280:           <span class="ruby-identifier">_pid</span> = <span class="ruby-keyword kw">nil</span>
281:           <span class="ruby-identifier">command</span>.<span class="ruby-identifier">notify</span>(<span class="ruby-value str">&quot;job(%id) start to waiting finish.&quot;</span>, <span class="ruby-ivar">@shell</span>.<span class="ruby-identifier">debug?</span>)
282:           <span class="ruby-identifier">_pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>, <span class="ruby-keyword kw">nil</span>)
283:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECHILD</span>
284:           <span class="ruby-identifier">command</span>.<span class="ruby-identifier">notify</span> <span class="ruby-value str">&quot;warn: job(%id) was done already waitpid.&quot;</span>
285:           <span class="ruby-identifier">_pid</span> = <span class="ruby-keyword kw">true</span>
286:           <span class="ruby-comment cmt">#    rescue</span>
287:           <span class="ruby-comment cmt">#      STDERR.puts $!</span>
288:         <span class="ruby-keyword kw">ensure</span>
289:           <span class="ruby-identifier">command</span>.<span class="ruby-identifier">notify</span>(<span class="ruby-value str">&quot;Job(%id): Wait to finish when Process finished.&quot;</span>, <span class="ruby-ivar">@shell</span>.<span class="ruby-identifier">debug?</span>)
290:           <span class="ruby-comment cmt"># when the process ends, wait until the command terminates</span>
291:           <span class="ruby-keyword kw">if</span> <span class="ruby-constant">USING_AT_EXIT_WHEN_PROCESS_EXIT</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">_pid</span>
292:           <span class="ruby-keyword kw">else</span>
293:             <span class="ruby-identifier">command</span>.<span class="ruby-identifier">notify</span>(<span class="ruby-value str">&quot;notice: Process finishing...&quot;</span>,
294:                            <span class="ruby-value str">&quot;wait for Job[%id] to finish.&quot;</span>,
295:                            <span class="ruby-value str">&quot;You can use Shell#transact or Shell#check_point for more safe execution.&quot;</span>)
296:             <span class="ruby-keyword kw">redo</span>
297:           <span class="ruby-keyword kw">end</span>
298: 
299: <span class="ruby-comment cmt">#         command.notify &quot;job(%id) pre-pre-finish.&quot;, @shell.debug?</span>
300:           <span class="ruby-ivar">@job_monitor</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
301: <span class="ruby-comment cmt">#           command.notify &quot;job(%id) pre-finish.&quot;, @shell.debug?</span>
302:             <span class="ruby-identifier">terminate_job</span>(<span class="ruby-identifier">command</span>)
303: <span class="ruby-comment cmt">#           command.notify &quot;job(%id) pre-finish2.&quot;, @shell.debug?</span>
304:             <span class="ruby-ivar">@job_condition</span>.<span class="ruby-identifier">signal</span>
305:             <span class="ruby-identifier">command</span>.<span class="ruby-identifier">notify</span> <span class="ruby-value str">&quot;job(%id) finish.&quot;</span>, <span class="ruby-ivar">@shell</span>.<span class="ruby-identifier">debug?</span>
306:           <span class="ruby-keyword kw">end</span>
307:         <span class="ruby-keyword kw">end</span>
308:       <span class="ruby-keyword kw">end</span>
309: 
310:       <span class="ruby-identifier">pid_mutex</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
311:         <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pid</span>
312:           <span class="ruby-identifier">pid_cv</span>.<span class="ruby-identifier">wait</span>(<span class="ruby-identifier">pid_mutex</span>)
313:         <span class="ruby-keyword kw">end</span>
314:       <span class="ruby-keyword kw">end</span>
315: 
316:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pid</span>, <span class="ruby-identifier">pipe_me_in</span>, <span class="ruby-identifier">pipe_me_out</span>
317:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001842">
                    
                    <a name="M001842"></a><b>start_job</b>(command = nil)
                    
                </div>
                
                <div class="description">
                  <p>
start a job
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001842_source')" id="l_M001842_source">show</a>
                        
                    </p>
                    <div id="M001842_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 153</span>
153:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_job</span>(<span class="ruby-identifier">command</span> = <span class="ruby-keyword kw">nil</span>)
154:       <span class="ruby-ivar">@jobs_sync</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">:EX</span>) <span class="ruby-keyword kw">do</span>
155:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">command</span>
156:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">command</span>.<span class="ruby-identifier">active?</span>
157:           <span class="ruby-ivar">@waiting_jobs</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">command</span>
158:         <span class="ruby-keyword kw">else</span>
159:           <span class="ruby-identifier">command</span> = <span class="ruby-ivar">@waiting_jobs</span>.<span class="ruby-identifier">shift</span>
160: <span class="ruby-comment cmt">#         command.notify &quot;job(%id) pre-start.&quot;, @shell.debug?</span>
161: 
162:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">command</span>
163:         <span class="ruby-keyword kw">end</span>
164:         <span class="ruby-ivar">@active_jobs</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">command</span>
165:         <span class="ruby-identifier">command</span>.<span class="ruby-identifier">start</span>
166: <span class="ruby-comment cmt">#       command.notify &quot;job(%id) post-start.&quot;, @shell.debug?</span>
167: 
168:         <span class="ruby-comment cmt"># start all jobs that input from the job</span>
169:         <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">job</span> <span class="ruby-keyword kw">in</span> <span class="ruby-ivar">@waiting_jobs</span>.<span class="ruby-identifier">dup</span>
170:           <span class="ruby-identifier">start_job</span>(<span class="ruby-identifier">job</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">job</span>.<span class="ruby-identifier">input</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">command</span>
171:         <span class="ruby-keyword kw">end</span>
172: <span class="ruby-comment cmt">#       command.notify &quot;job(%id) post2-start.&quot;, @shell.debug?</span>
173:       <span class="ruby-keyword kw">end</span>
174:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001845">
                    
                    <a name="M001845"></a><b>terminate_job</b>(command)
                    
                </div>
                
                <div class="description">
                  <p>
terminate a job
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001845_source')" id="l_M001845_source">show</a>
                        
                    </p>
                    <div id="M001845_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 189</span>
189:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">terminate_job</span>(<span class="ruby-identifier">command</span>)
190:       <span class="ruby-ivar">@jobs_sync</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">:EX</span>) <span class="ruby-keyword kw">do</span>
191:         <span class="ruby-ivar">@active_jobs</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">command</span>
192:         <span class="ruby-constant">ProcessController</span>.<span class="ruby-identifier">inactivate</span>(<span class="ruby-keyword kw">self</span>)
193:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@active_jobs</span>.<span class="ruby-identifier">empty?</span>
194:           <span class="ruby-identifier">command</span>.<span class="ruby-identifier">notify</span>(<span class="ruby-value str">&quot;start_job in terminate_job(%id)&quot;</span>, <span class="ruby-constant">Shell</span><span class="ruby-operator">::</span><span class="ruby-identifier">debug?</span>)
195:           <span class="ruby-identifier">start_job</span>
196:         <span class="ruby-keyword kw">end</span>
197:       <span class="ruby-keyword kw">end</span>
198:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001847">
                    
                    <a name="M001847"></a><b>wait_all_jobs_execution</b>()
                    
                </div>
                
                <div class="description">
                  <p>
wait for all jobs to terminate
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001847_source')" id="l_M001847_source">show</a>
                        
                    </p>
                    <div id="M001847_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 221</span>
221:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wait_all_jobs_execution</span>
222:       <span class="ruby-ivar">@job_monitor</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
223:         <span class="ruby-keyword kw">begin</span>
224:           <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-identifier">jobs</span>.<span class="ruby-identifier">empty?</span>
225:             <span class="ruby-ivar">@job_condition</span>.<span class="ruby-identifier">wait</span>(<span class="ruby-ivar">@job_monitor</span>)
226:             <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">job</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">jobs</span>
227:               <span class="ruby-identifier">job</span>.<span class="ruby-identifier">notify</span>(<span class="ruby-value str">&quot;waiting job(%id)&quot;</span>, <span class="ruby-constant">Shell</span><span class="ruby-operator">::</span><span class="ruby-identifier">debug?</span>)
228:             <span class="ruby-keyword kw">end</span>
229:           <span class="ruby-keyword kw">end</span>
230:         <span class="ruby-keyword kw">ensure</span>
231:           <span class="ruby-keyword kw">redo</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">jobs</span>.<span class="ruby-identifier">empty?</span>
232:         <span class="ruby-keyword kw">end</span>
233:       <span class="ruby-keyword kw">end</span>
234:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001843">
                    
                    <a name="M001843"></a><b>waiting_job?</b>(job)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001843_source')" id="l_M001843_source">show</a>
                        
                    </p>
                    <div id="M001843_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 176</span>
176:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">waiting_job?</span>(<span class="ruby-identifier">job</span>)
177:       <span class="ruby-ivar">@jobs_sync</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">:SH</span>) <span class="ruby-keyword kw">do</span>
178:         <span class="ruby-ivar">@waiting_jobs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">job</span>)
179:       <span class="ruby-keyword kw">end</span>
180:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001837">
                    
                    <a name="M001837"></a><b>waiting_jobs</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001837_source')" id="l_M001837_source">show</a>
                        
                    </p>
                    <div id="M001837_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 118</span>
118:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">waiting_jobs</span>
119:       <span class="ruby-ivar">@waiting_jobs</span>
120:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001840">
                    
                    <a name="M001840"></a><b>waiting_jobs_exist?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001840_source')" id="l_M001840_source">show</a>
                        
                    </p>
                    <div id="M001840_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/shell/process-controller.rb, line 134</span>
134:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">waiting_jobs_exist?</span>
135:       <span class="ruby-ivar">@jobs_sync</span>.<span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">:SH</span>) <span class="ruby-keyword kw">do</span>
136:         <span class="ruby-ivar">@waiting_jobs</span>.<span class="ruby-identifier">empty?</span>
137:       <span class="ruby-keyword kw">end</span>
138:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    