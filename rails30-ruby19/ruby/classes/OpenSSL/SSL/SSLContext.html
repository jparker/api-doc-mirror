<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>OpenSSL::SSL::SSLContext</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            OpenSSL::SSL::SSLContext 
            
                <span class="parent">&lt; 
                    
                    <a href="../../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/ext/openssl/ossl_ssl_session_c.html">ext/openssl/ossl_ssl_session.c</a></li>
            
            <li><a href="../../../files/ext/openssl/lib/openssl/ssl-internal_rb.html">ext/openssl/lib/openssl/ssl-internal.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
class <a href="SSLContext.html">SSLContext</a>
</p>
<pre>
    The following attributes are available but don't show up in rdoc.
    All attributes must be set before calling SSLSocket.new(io, ctx).
    * ssl_version, cert, key, client_ca, ca_file, ca_path, timeout,
    * verify_mode, verify_depth client_cert_cb, tmp_dh_callback,
    * session_id_context, session_add_cb, session_new_cb, session_remove_cb
</pre>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M006337">ciphers</a>,</li>
                
                <li><a href="#M006338">ciphers=</a></li>
                
            </ul>
        </dd>
    
        <dt>F</dt>
        <dd>
            <ul>
                
                <li><a href="#M006347">flush_sessions</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M006335">new</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M006340">session_add</a>,</li>
                
                <li><a href="#M006342">session_cache_mode</a>,</li>
                
                <li><a href="#M006343">session_cache_mode=</a>,</li>
                
                <li><a href="#M006344">session_cache_size</a>,</li>
                
                <li><a href="#M006345">session_cache_size=</a>,</li>
                
                <li><a href="#M006346">session_cache_stats</a>,</li>
                
                <li><a href="#M006341">session_remove</a>,</li>
                
                <li><a href="#M007220">set_params</a>,</li>
                
                <li><a href="#M006339">setup</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">SESSION_CACHE_OFF</td>
            <td>=</td>
            <td class="attr-value">LONG2FIX(SSL_SESS_CACHE_OFF)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">SESSION_CACHE_CLIENT</td>
            <td>=</td>
            <td class="attr-value">LONG2FIX(SSL_SESS_CACHE_CLIENT)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">SESSION_CACHE_SERVER</td>
            <td>=</td>
            <td class="attr-value">LONG2FIX(SSL_SESS_CACHE_SERVER)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">SESSION_CACHE_BOTH</td>
            <td>=</td>
            <td class="attr-value">LONG2FIX(SSL_SESS_CACHE_BOTH)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">SESSION_CACHE_NO_AUTO_CLEAR</td>
            <td>=</td>
            <td class="attr-value">LONG2FIX(SSL_SESS_CACHE_NO_AUTO_CLEAR)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">SESSION_CACHE_NO_INTERNAL_LOOKUP</td>
            <td>=</td>
            <td class="attr-value">LONG2FIX(SSL_SESS_CACHE_NO_INTERNAL_LOOKUP)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">SESSION_CACHE_NO_INTERNAL_STORE</td>
            <td>=</td>
            <td class="attr-value">LONG2FIX(SSL_SESS_CACHE_NO_INTERNAL_STORE)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">SESSION_CACHE_NO_INTERNAL</td>
            <td>=</td>
            <td class="attr-value">LONG2FIX(SSL_SESS_CACHE_NO_INTERNAL)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">METHODS</td>
            <td>=</td>
            <td class="attr-value">ary</td>
        </tr>
        
        <tr valign='top'>
            <td>&nbsp;</td>
            <td colspan="2" class="attr-desc"><p>
holds a list of available SSL/TLS methods
</p>
</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">DEFAULT_PARAMS</td>
            <td>=</td>
            <td class="attr-value">{         :ssl_version =&gt; &quot;SSLv23&quot;,         :verify_mode =&gt; OpenSSL::SSL::VERIFY_PEER,         :ciphers =&gt; &quot;ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW&quot;,         :options =&gt; OpenSSL::SSL::OP_ALL,       }</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">DEFAULT_CERT_STORE</td>
            <td>=</td>
            <td class="attr-value">OpenSSL::X509::Store.new</td>
        </tr>
        
        
    </table>
    

    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M006335">
                    
                    <a name="M006335"></a><b>SSLContext.new => ctx
SSLContext.new(:TLSv1) => ctx
SSLContext.new("SSLv23_client") => ctx
</b>
                    
                </div>
                
                <div class="description">
                  <p>
You can get a list of valid methods with OpenSSL::SSL::SSLContext::METHODS
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006335_source')" id="l_M006335_source">show</a>
                        
                    </p>
                    <div id="M006335_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_initialize(int argc, VALUE *argv, VALUE self)
{
    VALUE ssl_method;
    int i;

    for(i = 0; i &lt; numberof(ossl_sslctx_attrs); i++){
        char buf[32];
        snprintf(buf, sizeof(buf), &quot;@%s&quot;, ossl_sslctx_attrs[i]);
        rb_iv_set(self, buf, Qnil);
    }
    if (rb_scan_args(argc, argv, &quot;01&quot;, &amp;ssl_method) == 0){
        return self;
    }
    ossl_sslctx_set_ssl_version(self, ssl_method);

    return self;
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M006337">
                    
                    <a name="M006337"></a><b>ciphers</b>()
                    
                </div>
                
                <div class="description">
                  <p>
call-seq:
</p>
<pre>
   ctx.ciphers =&gt; [[name, version, bits, alg_bits], ...]
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006337_source')" id="l_M006337_source">show</a>
                        
                    </p>
                    <div id="M006337_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_get_ciphers(VALUE self)
{
    SSL_CTX *ctx;
    STACK_OF(SSL_CIPHER) *ciphers;
    SSL_CIPHER *cipher;
    VALUE ary;
    int i, num;

    Data_Get_Struct(self, SSL_CTX, ctx);
    if(!ctx){
        rb_warning(&quot;SSL_CTX is not initialized.&quot;);
        return Qnil;
    }
    ciphers = ctx-&gt;cipher_list;

    if (!ciphers)
        return rb_ary_new();

    num = sk_num((STACK*)ciphers);
    ary = rb_ary_new2(num);
    for(i = 0; i &lt; num; i++){
        cipher = (SSL_CIPHER*)sk_value((STACK*)ciphers, i);
        rb_ary_push(ary, ossl_ssl_cipher_to_ary(cipher));
    }
    return ary;
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006338">
                    
                    <a name="M006338"></a><b>ciphers=</b>(p1)
                    
                </div>
                
                <div class="description">
                  <p>
call-seq:
</p>
<pre>
   ctx.ciphers = &quot;cipher1:cipher2:...&quot;
   ctx.ciphers = [name, ...]
   ctx.ciphers = [[name, version, bits, alg_bits], ...]
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006338_source')" id="l_M006338_source">show</a>
                        
                    </p>
                    <div id="M006338_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_set_ciphers(VALUE self, VALUE v)
{
    SSL_CTX *ctx;
    VALUE str, elem;
    int i;

    rb_check_frozen(self);
    if (NIL_P(v))
        return v;
    else if (TYPE(v) == T_ARRAY) {
        str = rb_str_new(0, 0);
        for (i = 0; i &lt; RARRAY_LEN(v); i++) {
            elem = rb_ary_entry(v, i);
            if (TYPE(elem) == T_ARRAY) elem = rb_ary_entry(elem, 0);
            elem = rb_String(elem);
            rb_str_append(str, elem);
            if (i &lt; RARRAY_LEN(v)-1) rb_str_cat2(str, &quot;:&quot;);
        }
    } else {
        str = v;
        StringValue(str);
    }

    Data_Get_Struct(self, SSL_CTX, ctx);
    if(!ctx){
        ossl_raise(eSSLError, &quot;SSL_CTX is not initialized.&quot;);
        return Qnil;
    }
    if (!SSL_CTX_set_cipher_list(ctx, RSTRING_PTR(str))) {
        ossl_raise(eSSLError, &quot;SSL_CTX_set_cipher_list:&quot;);
    }

    return v;
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006347">
                    
                    <a name="M006347"></a><b>ctx.flush_sessions(time | nil) &rarr; self
</b>
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006347_source')" id="l_M006347_source">show</a>
                        
                    </p>
                    <div id="M006347_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_flush_sessions(int argc, VALUE *argv, VALUE self)
{
    VALUE arg1;
    SSL_CTX *ctx;
    time_t tm = 0;

    rb_scan_args(argc, argv, &quot;01&quot;, &amp;arg1);

    Data_Get_Struct(self, SSL_CTX, ctx);

    if (NIL_P(arg1)) {
        tm = time(0);
    } else if (rb_obj_is_instance_of(arg1, rb_cTime)) {
        tm = NUM2LONG(rb_funcall(arg1, rb_intern(&quot;to_i&quot;), 0));
    } else {
        rb_raise(rb_eArgError, &quot;arg must be Time or nil&quot;);
    }

    SSL_CTX_flush_sessions(ctx, (long)tm);

    return self;
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006340">
                    
                    <a name="M006340"></a><b>ctx.session_add(session) &rarr; true | false
</b>
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006340_source')" id="l_M006340_source">show</a>
                        
                    </p>
                    <div id="M006340_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_session_add(VALUE self, VALUE arg)
{
    SSL_CTX *ctx;
    SSL_SESSION *sess;

    Data_Get_Struct(self, SSL_CTX, ctx);
    SafeGetSSLSession(arg, sess);

    return SSL_CTX_add_session(ctx, sess) == 1 ? Qtrue : Qfalse;
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006342">
                    
                    <a name="M006342"></a><b>ctx.session_cache_mode &rarr; integer
</b>
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006342_source')" id="l_M006342_source">show</a>
                        
                    </p>
                    <div id="M006342_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_get_session_cache_mode(VALUE self)
{
    SSL_CTX *ctx;

    Data_Get_Struct(self, SSL_CTX, ctx);

    return LONG2NUM(SSL_CTX_get_session_cache_mode(ctx));
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006343">
                    
                    <a name="M006343"></a><b>ctx.session_cache_mode=(integer) &rarr; integer
</b>
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006343_source')" id="l_M006343_source">show</a>
                        
                    </p>
                    <div id="M006343_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_set_session_cache_mode(VALUE self, VALUE arg)
{
    SSL_CTX *ctx;

    Data_Get_Struct(self, SSL_CTX, ctx);

    SSL_CTX_set_session_cache_mode(ctx, NUM2LONG(arg));

    return arg;
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006344">
                    
                    <a name="M006344"></a><b>ctx.session_cache_size &rarr; integer
</b>
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006344_source')" id="l_M006344_source">show</a>
                        
                    </p>
                    <div id="M006344_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_get_session_cache_size(VALUE self)
{
    SSL_CTX *ctx;

    Data_Get_Struct(self, SSL_CTX, ctx);

    return LONG2NUM(SSL_CTX_sess_get_cache_size(ctx));
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006345">
                    
                    <a name="M006345"></a><b>ctx.session_cache_size=(integer) &rarr; integer
</b>
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006345_source')" id="l_M006345_source">show</a>
                        
                    </p>
                    <div id="M006345_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_set_session_cache_size(VALUE self, VALUE arg)
{
    SSL_CTX *ctx;

    Data_Get_Struct(self, SSL_CTX, ctx);

    SSL_CTX_sess_set_cache_size(ctx, NUM2LONG(arg));

    return arg;
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006346">
                    
                    <a name="M006346"></a><b>ctx.session_cache_stats &rarr; Hash
</b>
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006346_source')" id="l_M006346_source">show</a>
                        
                    </p>
                    <div id="M006346_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_get_session_cache_stats(VALUE self)
{
    SSL_CTX *ctx;
    VALUE hash;

    Data_Get_Struct(self, SSL_CTX, ctx);

    hash = rb_hash_new();
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;cache_num&quot;)), LONG2NUM(SSL_CTX_sess_number(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;connect&quot;)), LONG2NUM(SSL_CTX_sess_connect(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;connect_good&quot;)), LONG2NUM(SSL_CTX_sess_connect_good(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;connect_renegotiate&quot;)), LONG2NUM(SSL_CTX_sess_connect_renegotiate(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;accept&quot;)), LONG2NUM(SSL_CTX_sess_accept(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;accept_good&quot;)), LONG2NUM(SSL_CTX_sess_accept_good(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;accept_renegotiate&quot;)), LONG2NUM(SSL_CTX_sess_accept_renegotiate(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;cache_hits&quot;)), LONG2NUM(SSL_CTX_sess_hits(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;cb_hits&quot;)), LONG2NUM(SSL_CTX_sess_cb_hits(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;cache_misses&quot;)), LONG2NUM(SSL_CTX_sess_misses(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;cache_full&quot;)), LONG2NUM(SSL_CTX_sess_cache_full(ctx)));
    rb_hash_aset(hash, ID2SYM(rb_intern(&quot;timeouts&quot;)), LONG2NUM(SSL_CTX_sess_timeouts(ctx)));

    return hash;
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006341">
                    
                    <a name="M006341"></a><b>ctx.session_remove(session) &rarr; true | false
</b>
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006341_source')" id="l_M006341_source">show</a>
                        
                    </p>
                    <div id="M006341_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_session_remove(VALUE self, VALUE arg)
{
    SSL_CTX *ctx;
    SSL_SESSION *sess;

    Data_Get_Struct(self, SSL_CTX, ctx);
    SafeGetSSLSession(arg, sess);

    return SSL_CTX_remove_session(ctx, sess) == 1 ? Qtrue : Qfalse;
}</pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M007220">
                    
                    <a name="M007220"></a><b>set_params</b>(params={})
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007220_source')" id="l_M007220_source">show</a>
                        
                    </p>
                    <div id="M007220_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File ext/openssl/lib/openssl/ssl-internal.rb, line 36</span>
36:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_params</span>(<span class="ruby-identifier">params</span>={})
37:         <span class="ruby-identifier">params</span> = <span class="ruby-constant">DEFAULT_PARAMS</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">params</span>)
38:         <span class="ruby-identifier">params</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">__send__</span>(<span class="ruby-node">&quot;#{name}=&quot;</span>, <span class="ruby-identifier">value</span>) }
39:         <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">verify_mode</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSL</span><span class="ruby-operator">::</span><span class="ruby-constant">VERIFY_NONE</span>
40:           <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">ca_file</span> <span class="ruby-keyword kw">or</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">ca_path</span> <span class="ruby-keyword kw">or</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">cert_store</span>
41:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">cert_store</span> = <span class="ruby-constant">DEFAULT_CERT_STORE</span>
42:           <span class="ruby-keyword kw">end</span>
43:         <span class="ruby-keyword kw">end</span>
44:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">params</span>
45:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006339">
                    
                    <a name="M006339"></a><b>ctx.setup => Qtrue # first time
ctx.setup => nil # thereafter
</b>
                    
                </div>
                
                <div class="description">
                  <p>
This method is called automatically when a new <a
href="SSLSocket.html">SSLSocket</a> is created. Normally you do not need to
call this method (unless you are writing an extension in C).
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006339_source')" id="l_M006339_source">show</a>
                        
                    </p>
                    <div id="M006339_source" class="dyn-source">
                        <pre>static VALUE
ossl_sslctx_setup(VALUE self)
{
    SSL_CTX *ctx;
    X509 *cert = NULL, *client_ca = NULL;
    X509_STORE *store;
    EVP_PKEY *key = NULL;
    char *ca_path = NULL, *ca_file = NULL;
    int i, verify_mode;
    VALUE val;

    if(OBJ_FROZEN(self)) return Qnil;
    Data_Get_Struct(self, SSL_CTX, ctx);

#if !defined(OPENSSL_NO_DH)
    if (RTEST(ossl_sslctx_get_tmp_dh_cb(self))){
        SSL_CTX_set_tmp_dh_callback(ctx, ossl_tmp_dh_callback);
    }
    else{
        SSL_CTX_set_tmp_dh_callback(ctx, ossl_default_tmp_dh_callback);
    }
#endif
    SSL_CTX_set_ex_data(ctx, ossl_ssl_ex_ptr_idx, (void*)self);

    val = ossl_sslctx_get_cert_store(self);
    if(!NIL_P(val)){
        /*
         * WORKAROUND:
         *   X509_STORE can count references, but
         *   X509_STORE_free() doesn't care it.
         *   So we won't increment it but mark it by ex_data.
         */
        store = GetX509StorePtr(val); /* NO NEED TO DUP */
        SSL_CTX_set_cert_store(ctx, store);
        SSL_CTX_set_ex_data(ctx, ossl_ssl_ex_store_p, (void*)1);
    }

    val = ossl_sslctx_get_extra_cert(self);
    if(!NIL_P(val)){
        rb_block_call(val, rb_intern(&quot;each&quot;), 0, 0, ossl_sslctx_add_extra_chain_cert_i, self);
    }

    /* private key may be bundled in certificate file. */
    val = ossl_sslctx_get_cert(self);
    cert = NIL_P(val) ? NULL : GetX509CertPtr(val); /* NO DUP NEEDED */
    val = ossl_sslctx_get_key(self);
    key = NIL_P(val) ? NULL : GetPKeyPtr(val); /* NO DUP NEEDED */
    if (cert &amp;&amp; key) {
        if (!SSL_CTX_use_certificate(ctx, cert)) {
            /* Adds a ref =&gt; Safe to FREE */
            ossl_raise(eSSLError, &quot;SSL_CTX_use_certificate:&quot;);
        }
        if (!SSL_CTX_use_PrivateKey(ctx, key)) {
            /* Adds a ref =&gt; Safe to FREE */
            ossl_raise(eSSLError, &quot;SSL_CTX_use_PrivateKey:&quot;);
        }
        if (!SSL_CTX_check_private_key(ctx)) {
            ossl_raise(eSSLError, &quot;SSL_CTX_check_private_key:&quot;);
        }
    }

    val = ossl_sslctx_get_client_ca(self);
    if(!NIL_P(val)){
        if(TYPE(val) == T_ARRAY){
            for(i = 0; i &lt; RARRAY_LEN(val); i++){
                client_ca = GetX509CertPtr(RARRAY_PTR(val)[i]);
                if (!SSL_CTX_add_client_CA(ctx, client_ca)){
                    /* Copies X509_NAME =&gt; FREE it. */
                    ossl_raise(eSSLError, &quot;SSL_CTX_add_client_CA&quot;);
                }
            }
        }
        else{
            client_ca = GetX509CertPtr(val); /* NO DUP NEEDED. */
            if (!SSL_CTX_add_client_CA(ctx, client_ca)){
                /* Copies X509_NAME =&gt; FREE it. */
                ossl_raise(eSSLError, &quot;SSL_CTX_add_client_CA&quot;);
            }
        }
    }

    val = ossl_sslctx_get_ca_file(self);
    ca_file = NIL_P(val) ? NULL : StringValuePtr(val);
    val = ossl_sslctx_get_ca_path(self);
    ca_path = NIL_P(val) ? NULL : StringValuePtr(val);
    if(ca_file || ca_path){
        if (!SSL_CTX_load_verify_locations(ctx, ca_file, ca_path))
            rb_warning(&quot;can't set verify locations&quot;);
    }

    val = ossl_sslctx_get_verify_mode(self);
    verify_mode = NIL_P(val) ? SSL_VERIFY_NONE : NUM2INT(val);
    SSL_CTX_set_verify(ctx, verify_mode, ossl_ssl_verify_callback);
    if (RTEST(ossl_sslctx_get_client_cert_cb(self)))
        SSL_CTX_set_client_cert_cb(ctx, ossl_client_cert_cb);

    val = ossl_sslctx_get_timeout(self);
    if(!NIL_P(val)) SSL_CTX_set_timeout(ctx, NUM2LONG(val));

    val = ossl_sslctx_get_verify_dep(self);
    if(!NIL_P(val)) SSL_CTX_set_verify_depth(ctx, NUM2LONG(val));

    val = ossl_sslctx_get_options(self);
    if(!NIL_P(val)) SSL_CTX_set_options(ctx, NUM2LONG(val));
    rb_obj_freeze(self);

    val = ossl_sslctx_get_sess_id_ctx(self);
    if (!NIL_P(val)){
        StringValue(val);
        if (!SSL_CTX_set_session_id_context(ctx, (unsigned char *)RSTRING_PTR(val),
                                            RSTRING_LEN(val))){
            ossl_raise(eSSLError, &quot;SSL_CTX_set_session_id_context:&quot;);
        }
    }

    if (RTEST(rb_iv_get(self, &quot;@session_get_cb&quot;))) {
        SSL_CTX_sess_set_get_cb(ctx, ossl_sslctx_session_get_cb);
        OSSL_Debug(&quot;SSL SESSION get callback added&quot;);
    }
    if (RTEST(rb_iv_get(self, &quot;@session_new_cb&quot;))) {
        SSL_CTX_sess_set_new_cb(ctx, ossl_sslctx_session_new_cb);
        OSSL_Debug(&quot;SSL SESSION new callback added&quot;);
    }
    if (RTEST(rb_iv_get(self, &quot;@session_remove_cb&quot;))) {
        SSL_CTX_sess_set_remove_cb(ctx, ossl_sslctx_session_remove_cb);
        OSSL_Debug(&quot;SSL SESSION remove callback added&quot;);
    }

#ifdef HAVE_SSL_SET_TLSEXT_HOST_NAME
    val = rb_iv_get(self, &quot;@servername_cb&quot;);
    if (!NIL_P(val)) {
        SSL_CTX_set_tlsext_servername_callback(ctx, ssl_servername_cb);
        OSSL_Debug(&quot;SSL TLSEXT servername callback added&quot;);
    }
#endif

    return Qtrue;
}</pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    