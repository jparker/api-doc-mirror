<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>CGI::QueryExtension</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            CGI::QueryExtension 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/cgi_rb.html">lib/cgi.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Mixin module. It provides the follow functionality groups:
</p>
<ol>
<li>Access to <a href="../CGI.html">CGI</a> environment variables as methods.
See documentation to the <a href="../CGI.html">CGI</a> class for a list of
these variables.

</li>
<li>Access to cookies, including the cookies attribute.

</li>
<li>Access to parameters, including the params attribute, and overloading

<dl>
<dt></dt><dd>to perform parameter value lookup by key.

</dd>
</dl>
</li>
<li>The <a href="QueryExtension.html#M003568">initialize_query</a> method, for
initialising the above mechanisms, handling multipart forms, and allowing
the class to be used in &#8220;offline&#8221; mode.

</li>
</ol>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>#</dt>
        <dd>
            <ul>
                
                <li><a href="#M003570">[]</a></li>
                
            </ul>
        </dd>
    
        <dt>H</dt>
        <dd>
            <ul>
                
                <li><a href="#M003572">has_key?</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M003574">include?</a>,</li>
                
                <li><a href="#M003568">initialize_query</a></li>
                
            </ul>
        </dd>
    
        <dt>K</dt>
        <dd>
            <ul>
                
                <li><a href="#M003573">key?</a>,</li>
                
                <li><a href="#M003571">keys</a></li>
                
            </ul>
        </dd>
    
        <dt>M</dt>
        <dd>
            <ul>
                
                <li><a href="#M003569">multipart?</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M003565">params=</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M003563">raw_cookie</a>,</li>
                
                <li><a href="#M003564">raw_cookie2</a>,</li>
                
                <li><a href="#M003567">read_from_cmdline</a>,</li>
                
                <li><a href="#M003566">read_multipart</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">MODULE</span> <a href="QueryExtension/Value.html">CGI::QueryExtension::Value</a></li>
        
    </ul>
    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>cookies</td>
            <td class='attr-desc'><p>
Get the cookies as a hash of cookie-name=><a href="Cookie.html">Cookie</a>
pairs.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>params</td>
            <td class='attr-desc'><p>
Get the parameters as a hash of name=>values pairs, where values is an <a
href="../Array.html">Array</a>.
</p></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M003570">
                    
                    <a name="M003570"></a><b>[]</b>(key)
                    
                </div>
                
                <div class="description">
                  <p>
Get the value for the parameter with a given key.
</p>
<p>
If the parameter has multiple values, only the first will be retrieved; use
params() to get the array of values.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M003570_source')" id="l_M003570_source">show</a>
                        
                    </p>
                    <div id="M003570_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/cgi.rb, line 1169</span>
1169:     <span class="ruby-keyword kw">def</span> <span class="ruby-operator">[]</span>(<span class="ruby-identifier">key</span>)
1170:       <span class="ruby-identifier">params</span> = <span class="ruby-ivar">@params</span>[<span class="ruby-identifier">key</span>]
1171:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">''</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>
1172:       <span class="ruby-identifier">value</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">0</span>]
1173:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@multipart</span>
1174:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span>
1175:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">value</span>
1176:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-keyword kw">defined?</span> <span class="ruby-constant">StringIO</span>
1177:           <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;&quot;</span>)
1178:         <span class="ruby-keyword kw">else</span>
1179:           <span class="ruby-constant">Tempfile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;CGI&quot;</span>)
1180:         <span class="ruby-keyword kw">end</span>
1181:       <span class="ruby-keyword kw">else</span>
1182:         <span class="ruby-identifier">str</span> = <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">dup</span> <span class="ruby-keyword kw">else</span> <span class="ruby-value str">&quot;&quot;</span> <span class="ruby-keyword kw">end</span>
1183:         <span class="ruby-identifier">str</span>.<span class="ruby-identifier">extend</span>(<span class="ruby-constant">Value</span>)
1184:         <span class="ruby-identifier">str</span>.<span class="ruby-identifier">set_params</span>(<span class="ruby-identifier">params</span>)
1185:         <span class="ruby-identifier">str</span>
1186:       <span class="ruby-keyword kw">end</span>
1187:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M003572">
                    
                    <a name="M003572"></a><b>has_key?</b>(*args)
                    
                </div>
                
                <div class="description">
                  <p>
Returns true if a given parameter key exists in the query.
</p>

                </div>
                
                
                <div class="aka">
                    This method is also aliased as
                    
                    <a href="QueryExtension.html#M003573">key?</a>
                    
                    <a href="QueryExtension.html#M003574">include?</a>
                    
                </div>
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M003572_source')" id="l_M003572_source">show</a>
                        
                    </p>
                    <div id="M003572_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/cgi.rb, line 1195</span>
1195:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_key?</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
1196:       <span class="ruby-ivar">@params</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
1197:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M003574">
                    
                    <a name="M003574"></a><b>include?</b>(*args)
                    
                </div>
                
                <div class="description">
                  <p>
Alias for <a href="QueryExtension.html#M003572">has_key?</a>
</p>

                </div>
                
                
                
            </div>
            
            <div class="method">
                <div class="title" id="M003573">
                    
                    <a name="M003573"></a><b>key?</b>(*args)
                    
                </div>
                
                <div class="description">
                  <p>
Alias for <a href="QueryExtension.html#M003572">has_key?</a>
</p>

                </div>
                
                
                
            </div>
            
            <div class="method">
                <div class="title" id="M003571">
                    
                    <a name="M003571"></a><b>keys</b>(*args)
                    
                </div>
                
                <div class="description">
                  <p>
Return all parameter keys as an array.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M003571_source')" id="l_M003571_source">show</a>
                        
                    </p>
                    <div id="M003571_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/cgi.rb, line 1190</span>
1190:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">keys</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
1191:       <span class="ruby-ivar">@params</span>.<span class="ruby-identifier">keys</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
1192:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M003569">
                    
                    <a name="M003569"></a><b>multipart?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M003569_source')" id="l_M003569_source">show</a>
                        
                    </p>
                    <div id="M003569_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/cgi.rb, line 1138</span>
1138:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">multipart?</span>
1139:       <span class="ruby-ivar">@multipart</span>
1140:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M003565">
                    
                    <a name="M003565"></a><b>params=</b>(hash)
                    
                </div>
                
                <div class="description">
                  <p>
<a href="../Set.html">Set</a> all the parameters.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M003565_source')" id="l_M003565_source">show</a>
                        
                    </p>
                    <div id="M003565_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi.rb, line 968</span>
968:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">params=</span>(<span class="ruby-identifier">hash</span>)
969:       <span class="ruby-ivar">@params</span>.<span class="ruby-identifier">clear</span>
970:       <span class="ruby-ivar">@params</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">hash</span>)
971:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M003563">
                    
                    <a name="M003563"></a><b>raw_cookie</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Get the raw cookies as a string.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M003563_source')" id="l_M003563_source">show</a>
                        
                    </p>
                    <div id="M003563_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi.rb, line 951</span>
951:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">raw_cookie</span>
952:       <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">&quot;HTTP_COOKIE&quot;</span>]
953:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M003564">
                    
                    <a name="M003564"></a><b>raw_cookie2</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Get the raw RFC2965 cookies as a string.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M003564_source')" id="l_M003564_source">show</a>
                        
                    </p>
                    <div id="M003564_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi.rb, line 956</span>
956:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">raw_cookie2</span>
957:       <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">&quot;HTTP_COOKIE2&quot;</span>]
958:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M003568">
                    
                    <a name="M003568"></a><b>initialize_query</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Initialize the data from the query.
</p>
<p>
Handles multipart forms (in particular, forms that involve file uploads).
Reads query parameters in the @params field, and cookies into @cookies.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M003568_source')" id="l_M003568_source">show</a>
                        
                    </p>
                    <div id="M003568_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/cgi.rb, line 1109</span>
1109:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize_query</span>()
1110:       <span class="ruby-keyword kw">if</span> (<span class="ruby-value str">&quot;POST&quot;</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'REQUEST_METHOD'</span>]) <span class="ruby-keyword kw">and</span>
1111:          <span class="ruby-regexp re">%r|\Amultipart/form-data.*boundary=\&quot;?([^\&quot;;,]+)\&quot;?|n</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'CONTENT_TYPE'</span>])
1112:         <span class="ruby-identifier">boundary</span> = <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">dup</span>
1113:         <span class="ruby-ivar">@multipart</span> = <span class="ruby-keyword kw">true</span>
1114:         <span class="ruby-ivar">@params</span> = <span class="ruby-identifier">read_multipart</span>(<span class="ruby-identifier">boundary</span>, <span class="ruby-constant">Integer</span>(<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'CONTENT_LENGTH'</span>]))
1115:       <span class="ruby-keyword kw">else</span>
1116:         <span class="ruby-ivar">@multipart</span> = <span class="ruby-keyword kw">false</span>
1117:         <span class="ruby-ivar">@params</span> = <span class="ruby-constant">CGI</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse</span>(
1118:                     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'REQUEST_METHOD'</span>]
1119:                     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;GET&quot;</span>, <span class="ruby-value str">&quot;HEAD&quot;</span>
1120:                       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">MOD_RUBY</span>)
1121:                         <span class="ruby-constant">Apache</span><span class="ruby-operator">::</span><span class="ruby-identifier">request</span>.<span class="ruby-identifier">args</span> <span class="ruby-keyword kw">or</span> <span class="ruby-value str">&quot;&quot;</span>
1122:                       <span class="ruby-keyword kw">else</span>
1123:                         <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'QUERY_STRING'</span>] <span class="ruby-keyword kw">or</span> <span class="ruby-value str">&quot;&quot;</span>
1124:                       <span class="ruby-keyword kw">end</span>
1125:                     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;POST&quot;</span>
1126:                       <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">binmode</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span> <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">binmode</span>
1127:                       <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">read</span>(<span class="ruby-constant">Integer</span>(<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'CONTENT_LENGTH'</span>])) <span class="ruby-keyword kw">or</span> <span class="ruby-value str">''</span>
1128:                     <span class="ruby-keyword kw">else</span>
1129:                       <span class="ruby-identifier">read_from_cmdline</span>
1130:                     <span class="ruby-keyword kw">end</span>
1131:                   )
1132:       <span class="ruby-keyword kw">end</span>
1133: 
1134:       <span class="ruby-ivar">@cookies</span> = <span class="ruby-constant">CGI</span><span class="ruby-operator">::</span><span class="ruby-constant">Cookie</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse</span>((<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'HTTP_COOKIE'</span>] <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'COOKIE'</span>]))
1135:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M003567">
                    
                    <a name="M003567"></a><b>read_from_cmdline</b>()
                    
                </div>
                
                <div class="description">
                  <p>
offline mode. read name=value pairs on standard input.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M003567_source')" id="l_M003567_source">show</a>
                        
                    </p>
                    <div id="M003567_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/cgi.rb, line 1081</span>
1081:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_from_cmdline</span>
1082:       <span class="ruby-identifier">require</span> <span class="ruby-value str">&quot;shellwords&quot;</span>
1083: 
1084:       <span class="ruby-identifier">string</span> = <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">empty?</span>
1085:         <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' '</span>)
1086:       <span class="ruby-keyword kw">else</span>
1087:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">STDIN</span>.<span class="ruby-identifier">tty?</span>
1088:           <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">print</span>(
1089:             <span class="ruby-value str">%|(offline mode: enter name=value pairs on standard input)\n|</span>
1090:           )
1091:         <span class="ruby-keyword kw">end</span>
1092:         <span class="ruby-identifier">readlines</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' '</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\n/n</span>, <span class="ruby-value str">''</span>)
1093:       <span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\\=/n</span>, <span class="ruby-value str">'%3D'</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\\&amp;/n</span>, <span class="ruby-value str">'%26'</span>)
1094: 
1095:       <span class="ruby-identifier">words</span> = <span class="ruby-constant">Shellwords</span>.<span class="ruby-identifier">shellwords</span>(<span class="ruby-identifier">string</span>)
1096: 
1097:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">words</span>.<span class="ruby-identifier">find</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-regexp re">/=/n</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">x</span>) }
1098:         <span class="ruby-identifier">words</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">'&amp;'</span>)
1099:       <span class="ruby-keyword kw">else</span>
1100:         <span class="ruby-identifier">words</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">'+'</span>)
1101:       <span class="ruby-keyword kw">end</span>
1102:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M003566">
                    
                    <a name="M003566"></a><b>read_multipart</b>(boundary, content_length)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M003566_source')" id="l_M003566_source">show</a>
                        
                    </p>
                    <div id="M003566_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/cgi.rb, line 973</span>
 973:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_multipart</span>(<span class="ruby-identifier">boundary</span>, <span class="ruby-identifier">content_length</span>)
 974:       <span class="ruby-identifier">params</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>([])
 975:       <span class="ruby-identifier">boundary</span> = <span class="ruby-value str">&quot;--&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">boundary</span>
 976:       <span class="ruby-identifier">quoted_boundary</span> = <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">quote</span>(<span class="ruby-identifier">boundary</span>, <span class="ruby-value str">&quot;n&quot;</span>)
 977:       <span class="ruby-identifier">buf</span> = <span class="ruby-value str">&quot;&quot;</span>
 978:       <span class="ruby-identifier">bufsize</span> = <span class="ruby-value">10</span> <span class="ruby-operator">*</span> <span class="ruby-value">1024</span>
 979:       <span class="ruby-identifier">boundary_end</span>=<span class="ruby-value str">&quot;&quot;</span>
 980: 
 981:       <span class="ruby-comment cmt"># start multipart/form-data</span>
 982:       <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">binmode</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span> <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">binmode</span>
 983:       <span class="ruby-identifier">boundary_size</span> = <span class="ruby-identifier">boundary</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-constant">EOL</span>.<span class="ruby-identifier">size</span>
 984:       <span class="ruby-identifier">content_length</span> <span class="ruby-operator">-=</span> <span class="ruby-identifier">boundary_size</span>
 985:       <span class="ruby-identifier">status</span> = <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">boundary_size</span>)
 986:       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">status</span>
 987:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>, <span class="ruby-value str">&quot;no content body&quot;</span>
 988:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">boundary</span> <span class="ruby-operator">+</span> <span class="ruby-constant">EOL</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">status</span>
 989:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>, <span class="ruby-value str">&quot;bad content body&quot;</span>
 990:       <span class="ruby-keyword kw">end</span>
 991: 
 992:       <span class="ruby-identifier">loop</span> <span class="ruby-keyword kw">do</span>
 993:         <span class="ruby-identifier">head</span> = <span class="ruby-keyword kw">nil</span>
 994:         <span class="ruby-keyword kw">if</span> <span class="ruby-value">10240</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">content_length</span>
 995:           <span class="ruby-identifier">require</span> <span class="ruby-value str">&quot;tempfile&quot;</span>
 996:           <span class="ruby-identifier">body</span> = <span class="ruby-constant">Tempfile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;CGI&quot;</span>)
 997:         <span class="ruby-keyword kw">else</span>
 998:           <span class="ruby-keyword kw">begin</span>
 999:             <span class="ruby-identifier">require</span> <span class="ruby-value str">&quot;stringio&quot;</span>
1000:             <span class="ruby-identifier">body</span> = <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>
1001:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">LoadError</span>
1002:             <span class="ruby-identifier">require</span> <span class="ruby-value str">&quot;tempfile&quot;</span>
1003:             <span class="ruby-identifier">body</span> = <span class="ruby-constant">Tempfile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;CGI&quot;</span>)
1004:           <span class="ruby-keyword kw">end</span>
1005:         <span class="ruby-keyword kw">end</span>
1006:         <span class="ruby-identifier">body</span>.<span class="ruby-identifier">binmode</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">binmode</span>
1007: 
1008:         <span class="ruby-keyword kw">until</span> <span class="ruby-identifier">head</span> <span class="ruby-keyword kw">and</span> <span class="ruby-node">/#{quoted_boundary}(?:#{EOL}|--)/n</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">buf</span>)
1009: 
1010:           <span class="ruby-keyword kw">if</span> (<span class="ruby-keyword kw">not</span> <span class="ruby-identifier">head</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-node">/#{EOL}#{EOL}/n</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">buf</span>)
1011:             <span class="ruby-identifier">buf</span> = <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-node">/\A((?:.|\n)*?#{EOL})#{EOL}/n</span>) <span class="ruby-keyword kw">do</span>
1012:               <span class="ruby-identifier">head</span> = <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">dup</span>
1013:               <span class="ruby-value str">&quot;&quot;</span>
1014:             <span class="ruby-keyword kw">end</span>
1015:             <span class="ruby-keyword kw">next</span>
1016:           <span class="ruby-keyword kw">end</span>
1017: 
1018:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">head</span> <span class="ruby-keyword kw">and</span> ( (<span class="ruby-constant">EOL</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">boundary</span> <span class="ruby-operator">+</span> <span class="ruby-constant">EOL</span>).<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">size</span> )
1019:             <span class="ruby-identifier">body</span>.<span class="ruby-identifier">print</span> <span class="ruby-identifier">buf</span>[<span class="ruby-value">0</span> <span class="ruby-operator">...</span> (<span class="ruby-identifier">buf</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> (<span class="ruby-constant">EOL</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">boundary</span> <span class="ruby-operator">+</span> <span class="ruby-constant">EOL</span>).<span class="ruby-identifier">size</span>)]
1020:             <span class="ruby-identifier">buf</span>[<span class="ruby-value">0</span> <span class="ruby-operator">...</span> (<span class="ruby-identifier">buf</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> (<span class="ruby-constant">EOL</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">boundary</span> <span class="ruby-operator">+</span> <span class="ruby-constant">EOL</span>).<span class="ruby-identifier">size</span>)] = <span class="ruby-value str">&quot;&quot;</span>
1021:           <span class="ruby-keyword kw">end</span>
1022: 
1023:           <span class="ruby-identifier">c</span> = <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">bufsize</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">content_length</span>
1024:                 <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">bufsize</span>)
1025:               <span class="ruby-keyword kw">else</span>
1026:                 <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">content_length</span>)
1027:               <span class="ruby-keyword kw">end</span>
1028:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">empty?</span>
1029:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>, <span class="ruby-value str">&quot;bad content body&quot;</span>
1030:           <span class="ruby-keyword kw">end</span>
1031:           <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">c</span>)
1032:           <span class="ruby-identifier">content_length</span> <span class="ruby-operator">-=</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">size</span>
1033:         <span class="ruby-keyword kw">end</span>
1034: 
1035:         <span class="ruby-identifier">buf</span> = <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-node">/\A((?:.|\n)*?)(?:[\r\n]{1,2})?#{quoted_boundary}([\r\n]{1,2}|--)/n</span>) <span class="ruby-keyword kw">do</span>
1036:           <span class="ruby-identifier">body</span>.<span class="ruby-identifier">print</span> <span class="ruby-identifier">$1</span>
1037:           <span class="ruby-keyword kw">if</span> <span class="ruby-value str">&quot;--&quot;</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">$2</span>
1038:             <span class="ruby-identifier">content_length</span> = <span class="ruby-value">-1</span>
1039:           <span class="ruby-keyword kw">end</span>
1040:           <span class="ruby-identifier">boundary_end</span> = <span class="ruby-identifier">$2</span>.<span class="ruby-identifier">dup</span>
1041:           <span class="ruby-value str">&quot;&quot;</span>
1042:         <span class="ruby-keyword kw">end</span>
1043: 
1044:         <span class="ruby-identifier">body</span>.<span class="ruby-identifier">rewind</span>
1045: 
1046:         <span class="ruby-regexp re">/Content-Disposition:.* filename=(?:&quot;((?:\\.|[^\&quot;])*)&quot;|([^;\s]*))/n</span><span class="ruby-identifier">i</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">head</span>)
1047:         <span class="ruby-identifier">filename</span> = (<span class="ruby-identifier">$1</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">$2</span> <span class="ruby-keyword kw">or</span> <span class="ruby-value str">&quot;&quot;</span>)
1048:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/Mac/n</span><span class="ruby-identifier">i</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'HTTP_USER_AGENT'</span>]) <span class="ruby-keyword kw">and</span>
1049:             <span class="ruby-regexp re">/Mozilla/n</span><span class="ruby-identifier">i</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'HTTP_USER_AGENT'</span>]) <span class="ruby-keyword kw">and</span>
1050:             (<span class="ruby-keyword kw">not</span> <span class="ruby-regexp re">/MSIE/n</span><span class="ruby-identifier">i</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'HTTP_USER_AGENT'</span>]))
1051:           <span class="ruby-identifier">filename</span> = <span class="ruby-constant">CGI</span><span class="ruby-operator">::</span><span class="ruby-identifier">unescape</span>(<span class="ruby-identifier">filename</span>)
1052:         <span class="ruby-keyword kw">end</span>
1053:         
1054:         <span class="ruby-regexp re">/Content-Type: ([^\s]*)/n</span><span class="ruby-identifier">i</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">head</span>)
1055:         <span class="ruby-identifier">content_type</span> = (<span class="ruby-identifier">$1</span> <span class="ruby-keyword kw">or</span> <span class="ruby-value str">&quot;&quot;</span>)
1056: 
1057:         (<span class="ruby-keyword kw">class</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>; <span class="ruby-keyword kw">self</span>; <span class="ruby-keyword kw">end</span>).<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword kw">do</span>
1058:           <span class="ruby-keyword kw">alias</span> <span class="ruby-identifier">local_path</span> <span class="ruby-identifier">path</span>
1059:           <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">:original_filename</span>) {<span class="ruby-identifier">filename</span>.<span class="ruby-identifier">dup</span>.<span class="ruby-identifier">taint</span>}
1060:           <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">:content_type</span>) {<span class="ruby-identifier">content_type</span>.<span class="ruby-identifier">dup</span>.<span class="ruby-identifier">taint</span>}
1061:         <span class="ruby-keyword kw">end</span>
1062: 
1063:         <span class="ruby-regexp re">/Content-Disposition:.* name=&quot;?([^\&quot;;\s]*)&quot;?/n</span><span class="ruby-identifier">i</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">head</span>)
1064:         <span class="ruby-identifier">name</span> = <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">dup</span>
1065: 
1066:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">name</span>)
1067:           <span class="ruby-identifier">params</span>[<span class="ruby-identifier">name</span>].<span class="ruby-identifier">push</span>(<span class="ruby-identifier">body</span>)
1068:         <span class="ruby-keyword kw">else</span>
1069:           <span class="ruby-identifier">params</span>[<span class="ruby-identifier">name</span>] = [<span class="ruby-identifier">body</span>]
1070:         <span class="ruby-keyword kw">end</span>
1071:         <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1072:         <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">content_length</span> <span class="ruby-operator">==</span> <span class="ruby-value">-1</span>
1073:       <span class="ruby-keyword kw">end</span>
1074:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>, <span class="ruby-value str">&quot;bad boundary end of body part&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">boundary_end</span><span class="ruby-operator">=~</span><span class="ruby-regexp re">/--/</span>
1075: 
1076:       <span class="ruby-identifier">params</span>
1077:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    